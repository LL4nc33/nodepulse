<%- include('../partials/header', { currentPath: '/nodes' }) %>

<div class="app-layout">
  <%- include('../partials/side-panel') %>

  <main class="main-panel">

<div class="page-header-compact">
  <div class="page-header-left">
    <nav class="breadcrumb-inline" aria-label="Breadcrumb">
      <a href="/nodes">Nodes</a> / <span><%= node.name %></span>
    </nav>
    <h1>
      <span class="status-dot <%= node.online ? 'online' : 'offline' %>"
            aria-label="Status: <%= node.online ? 'Online' : 'Offline' %>"></span>
      <%= node.name %>
    </h1>
  </div>
  <div class="page-actions">
    <button class="btn btn-icon btn-primary" id="btn-test" onclick="testConnection(<%= node.id %>)" title="SSH Test">
      <span class="btn-text">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="2" y="4" width="20" height="16" rx="2"/><path d="M6 8l4 4-4 4"/><line x1="12" y1="16" x2="18" y2="16"/>
        </svg>
      </span>
      <span class="btn-loading"><span class="spinner"></span></span>
    </button>
    <button class="btn btn-icon btn-secondary" id="btn-discover" onclick="runDiscovery(<%= node.id %>)" title="Discovery">
      <span class="btn-text">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
        </svg>
      </span>
      <span class="btn-loading"><span class="spinner"></span></span>
    </button>
    <button class="btn btn-icon btn-health-check <%= health && health.apt_updates > 0 ? 'btn-warning' : '' %>" onclick="runHealthCheck(<%= node.id %>)" title="Health Check">
      <span class="btn-text">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
        </svg>
        <% if (health && health.apt_updates > 0) { %>
          <span class="btn-badge"><%= health.apt_updates %></span>
        <% } %>
      </span>
      <span class="btn-loading"><span class="spinner"></span></span>
    </button>
    <a href="/nodes/<%= node.id %>/edit" class="btn">Bearbeiten</a>
  </div>
</div>

<!-- Last Scan Info Strip -->
<div class="last-scan-strip">
  <span class="scan-info">
    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
    </svg>
    Discovery: <strong><%= discovery && discovery.discovered_at ? discovery.discovered_at : 'Nie' %></strong>
  </span>
  <span class="scan-info">
    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
    </svg>
    Health: <strong><%= health && health.checked_at ? health.checked_at : 'Nie' %></strong>
  </span>
</div>

<div id="test-result" class="alert" role="alert" aria-live="polite" style="display: none;"></div>

<!-- Tab Navigation (mit SVG-Icons) -->
<%- include('../partials/node-detail/tabs-navigation') %>

<!-- Tab Contents -->
<%- include('../partials/node-detail/overview-tab') %>

<% if (discovery && discovery.has_docker) { %>
  <%- include('../partials/node-detail/docker-tab') %>
<% } %>

<% if (discovery && discovery.is_proxmox_host) { %>
  <%- include('../partials/node-detail/proxmox-tab') %>
<% } %>

<% if (discovery && discovery.is_proxmox_host) { %>
  <%- include('../partials/node-detail/storage-tab') %>
<% } %>

<% if (discovery && discovery.is_proxmox_host) { %>
  <%- include('../partials/node-detail/backup-tab') %>
<% } %>

<% if (discovery && discovery.is_proxmox_host) { %>
  <%- include('../partials/node-detail/tasks-tab') %>
<% } %>

<% if (discovery && discovery.has_systemd) { %>
  <%- include('../partials/node-detail/services-tab') %>
<% } %>

<%- include('../partials/node-detail/network-tab') %>

<!-- Modals -->
<%- include('../partials/node-detail/modals') %>

  </main>

  <!-- Terminal Bottom Panel (außerhalb main-panel) -->
  <%- include('../partials/node-detail/terminal-panel') %>
</div>

<!-- Node ID für JavaScript (muss VOR detail-page.js geladen werden) -->
<script>
  var nodeId = <%= node.id %>;
  var nodeName = <%- JSON.stringify(node.name) %>;
  var nodeData = {
    name: <%- JSON.stringify(node.name) %>,
    id: <%= node.id %>,
    sshUser: <%- JSON.stringify(node.ssh_user || 'root') %>
  };
</script>

<!-- External JavaScript -->
<!-- Terminal Tab Manager (must load before detail-page.js) -->
<script src="/static/js/detail/terminal-tabs.js?v=5.1"></script>
<script src="/static/js/detail-page.js?v=5.2"></script>

<%- include('../partials/footer') %>
