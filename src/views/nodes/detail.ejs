<%- include('../partials/header', { currentPath: '/nodes' }) %>

<div class="app-layout">
  <%- include('../partials/side-panel') %>

  <main class="main-panel">

<div class="page-header-compact">
  <div class="page-header-left">
    <nav class="breadcrumb-inline" aria-label="Breadcrumb">
      <a href="/nodes">Nodes</a>
      <% if (node.parent_id && typeof parentNode !== 'undefined' && parentNode) { %>
        / <a href="/nodes/<%= parentNode.id %>"><%= parentNode.name %></a>
      <% } %>
      / <span><%= node.name %></span>
    </nav>
    <h1>
      <span class="status-dot <%= node.online ? 'online' : 'offline' %>"
            aria-label="Status: <%= node.online ? 'Online' : 'Offline' %>"></span>
      <% if (node.guest_type) { %>
        <span class="guest-type-icon <%= node.guest_type %>" title="<%= node.guest_type === 'vm' ? 'Virtual Machine' : 'LXC Container' %>">
          <% if (node.guest_type === 'vm') { %>&#128187;<% } else { %>&#128230;<% } %>
        </span>
      <% } %>
      <%= node.name %>
      <% if (node.guest_vmid) { %>
        <span class="guest-vmid-badge" title="VMID: <%= node.guest_vmid %>">#<%= node.guest_vmid %></span>
      <% } %>
    </h1>
    <div class="node-info-inline">
      <% if (node.parent_id && typeof parentNode !== 'undefined' && parentNode) { %>
        <span class="parent-link">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="15 18 9 12 15 6"/>
          </svg>
          <a href="/nodes/<%= parentNode.id %>"><%= parentNode.name %></a>
        </span>
      <% } else { %>
        <span class="mono"><%= node.ssh_user %>@<%= node.host %>:<%= node.ssh_port %></span>
      <% } %>
      <% if (node.guest_type) { %>
        <span class="node-type-badge guest-badge <%= node.guest_type %>"><%= node.guest_type.toUpperCase() %></span>
      <% } else { %>
        <span class="node-type-badge"><%= node.node_type || 'Server' %></span>
      <% } %>
      <span class="monitoring-badge <%= node.monitoring_enabled ? 'active' : 'inactive' %>">
        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
        </svg>
        <%= node.monitoring_enabled ? node.monitoring_interval + 's' : 'Aus' %>
      </span>
      <% if (tags && tags.length > 0) { %>
        <% tags.forEach(function(tag) { %>
          <span class="tag-mini" style="background-color: <%= tag.color %>"><%= tag.name %></span>
        <% }); %>
      <% } %>
    </div>
  </div>
  <div class="page-actions">
    <div class="page-actions-buttons">
      <button class="btn btn-icon btn-primary" id="btn-test" onclick="testConnection(<%= node.id %>)" title="SSH Test">
        <span class="btn-text">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="2" y="4" width="20" height="16" rx="2"/><path d="M6 8l4 4-4 4"/><line x1="12" y1="16" x2="18" y2="16"/>
          </svg>
        </span>
        <span class="btn-loading"><span class="spinner"></span></span>
      </button>
      <button class="btn btn-icon btn-secondary" id="btn-discover" onclick="runDiscovery(<%= node.id %>)" title="Discovery">
        <span class="btn-text">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
          </svg>
        </span>
        <span class="btn-loading"><span class="spinner"></span></span>
      </button>
      <button class="btn btn-icon btn-health-check <%= health && health.apt_updates > 0 ? 'btn-warning' : '' %>" onclick="runHealthCheck(<%= node.id %>)" title="Health Check">
        <span class="btn-text">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
          </svg>
          <% if (health && health.apt_updates > 0) { %>
            <span class="btn-badge"><%= health.apt_updates %></span>
          <% } %>
        </span>
        <span class="btn-loading"><span class="spinner"></span></span>
      </button>
      <button class="btn btn-edit" onclick="openEditPanel()" title="Node bearbeiten">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
          <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
        </svg>
        <span>Bearbeiten</span>
      </button>
    </div>
    <div class="last-scan-info">
      <span class="scan-item" title="Letzte Discovery">
        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
        </svg>
        <%= discovery && discovery.discovered_at ? discovery.discovered_at : 'Nie' %>
      </span>
      <span class="scan-item" title="Letzter Health Check">
        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
        </svg>
        <%= health && health.checked_at ? health.checked_at : 'Nie' %>
      </span>
    </div>
  </div>
</div>

<div id="test-result" class="alert" role="alert" aria-live="polite" style="display: none;"></div>

<!-- Tab Navigation (mit SVG-Icons) -->
<%- include('../partials/node-detail/tabs-navigation') %>

<!-- Tab Contents -->
<%- include('../partials/node-detail/overview-tab') %>

<% if (discovery && discovery.has_docker) { %>
  <%- include('../partials/node-detail/docker-tab') %>
<% } %>

<% if (discovery && discovery.is_proxmox_host) { %>
  <%- include('../partials/node-detail/proxmox-tab') %>
<% } %>

<% if (discovery && discovery.is_proxmox_host) { %>
  <%- include('../partials/node-detail/storage-tab') %>
<% } %>

<% if (discovery && discovery.is_proxmox_host) { %>
  <%- include('../partials/node-detail/backup-tab') %>
<% } %>

<% if (discovery && discovery.is_proxmox_host) { %>
  <%- include('../partials/node-detail/tasks-tab') %>
<% } %>

<% if (discovery && discovery.has_systemd) { %>
  <%- include('../partials/node-detail/services-tab') %>
<% } %>

<%- include('../partials/node-detail/network-tab') %>

<!-- Modals -->
<%- include('../partials/node-detail/modals') %>

<!-- Edit Sidepanel -->
<div class="right-panel-overlay" id="editPanelOverlay" onclick="closeEditPanel()"></div>
<aside class="right-panel" id="editPanel">
  <div class="right-panel-header">
    <h2>
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
      </svg>
      Node bearbeiten
    </h2>
    <button class="right-panel-close" onclick="closeEditPanel()" title="Schliessen">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
      </svg>
    </button>
  </div>

  <form id="editNodeForm" onsubmit="saveNode(event)">
    <div class="right-panel-body">
      <!-- Basic Info -->
      <div class="right-panel-section">
        <h3>Grundeinstellungen</h3>
        <div class="form-group">
          <label for="edit-name">Name</label>
          <input type="text" id="edit-name" name="name" value="<%= node.name %>" required maxlength="255">
        </div>
        <div class="form-group">
          <label for="edit-host">Host / IP</label>
          <input type="text" id="edit-host" name="host" value="<%= node.host %>" required maxlength="255">
        </div>
      </div>

      <!-- SSH Settings -->
      <div class="right-panel-section">
        <h3>SSH Verbindung</h3>
        <div class="form-row">
          <div class="form-group">
            <label for="edit-ssh_user">User</label>
            <input type="text" id="edit-ssh_user" name="ssh_user" value="<%= node.ssh_user %>" required maxlength="64">
          </div>
          <div class="form-group form-group-small">
            <label for="edit-ssh_port">Port</label>
            <input type="number" id="edit-ssh_port" name="ssh_port" value="<%= node.ssh_port %>" min="1" max="65535">
          </div>
        </div>
        <div class="form-group">
          <label for="edit-ssh_password">Passwort</label>
          <input type="password" id="edit-ssh_password" name="ssh_password" autocomplete="new-password"
                 placeholder="<%= node.has_ssh_password ? 'Gesetzt - leer lassen zum Behalten' : 'Nicht gesetzt' %>">
        </div>
        <div class="form-group">
          <label for="edit-ssh_key_path">SSH Key Pfad</label>
          <input type="text" id="edit-ssh_key_path" name="ssh_key_path" value="<%= node.ssh_key_path || '' %>"
                 placeholder="z.B. ~/.ssh/id_rsa">
        </div>
      </div>

      <!-- Monitoring -->
      <div class="right-panel-section">
        <h3>Monitoring</h3>
        <div class="form-row">
          <div class="form-group">
            <label>Status</label>
            <input type="hidden" id="edit-monitoring_enabled" name="monitoring_enabled" value="<%= node.monitoring_enabled ? '1' : '0' %>">
            <button type="button" class="toggle-btn <%= node.monitoring_enabled ? 'active' : '' %>" id="monitoring-toggle" onclick="toggleMonitoring()">
              <svg class="toggle-icon-on" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18.36 6.64a9 9 0 1 1-12.73 0"/>
                <line x1="12" y1="2" x2="12" y2="12"/>
              </svg>
              <svg class="toggle-icon-off" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/>
              </svg>
              <span class="toggle-text"><%= node.monitoring_enabled ? 'AN' : 'AUS' %></span>
            </button>
          </div>
          <div class="form-group form-group-small">
            <label for="edit-monitoring_interval">Interval (Sek)</label>
            <input type="number" id="edit-monitoring_interval" name="monitoring_interval"
                   value="<%= node.monitoring_interval %>" min="5" max="3600">
          </div>
        </div>
      </div>

      <!-- Notes -->
      <div class="right-panel-section">
        <h3>Notizen</h3>
        <div class="form-group">
          <textarea id="edit-notes" name="notes" rows="3" placeholder="Optionale Notizen..."><%= node.notes || '' %></textarea>
        </div>
      </div>

      <!-- Danger Zone -->
      <details class="right-panel-danger">
        <summary>
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
            <line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
          </svg>
          Gefahrenzone
        </summary>
        <div class="right-panel-danger-content">
          <p>Node und alle zugehoerigen Daten unwiderruflich loeschen.</p>
          <button type="button" class="btn btn-danger btn-sm" onclick="deleteNode(<%= node.id %>, '<%= node.name %>')">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
            </svg>
            Node loeschen
          </button>
        </div>
      </details>
    </div>

    <div class="right-panel-footer">
      <button type="button" class="btn btn-secondary" onclick="closeEditPanel()">Abbrechen</button>
      <button type="submit" class="btn btn-primary" id="editSaveBtn">
        <span class="btn-text">Speichern</span>
        <span class="btn-loading"><span class="spinner"></span></span>
      </button>
    </div>
  </form>
</aside>

  </main>

  <!-- Terminal Bottom Panel (außerhalb main-panel) -->
  <%- include('../partials/node-detail/terminal-panel') %>
</div>

<!-- Node ID für JavaScript (muss VOR detail-page.js geladen werden) -->
<script>
  var nodeId = <%= node.id %>;
  var nodeName = <%- JSON.stringify(node.name) %>;
  var nodeData = {
    name: <%- JSON.stringify(node.name) %>,
    id: <%= node.id %>,
    sshUser: <%- JSON.stringify(node.ssh_user || 'root') %>
  };
</script>

<!-- External JavaScript -->
<!-- Charts Library (must load before detail-page.js for sparklines) -->
<script src="/static/js/charts.js?v=1.1"></script>
<!-- Terminal Tab Manager (must load before detail-page.js) -->
<script src="/static/js/detail/terminal-tabs.js?v=5.1"></script>
<script src="/static/js/detail-page.js?v=5.7"></script>

<%- include('../partials/footer') %>
