<%
  // Default values for sidebar data
  var sidebarNodes = typeof nodes !== 'undefined' ? nodes : [];
  var sidebarTree = typeof nodeTree !== 'undefined' ? nodeTree : [];
  var sidebarStats = typeof stats !== 'undefined' ? stats : { total: sidebarNodes.length, online: 0, offline: 0 };
  var sidebarTags = typeof tags !== 'undefined' ? tags : [];

  // Calculate stats if not provided
  if (!sidebarStats.total && sidebarNodes.length > 0) {
    var onlineCount = 0;
    for (var i = 0; i < sidebarNodes.length; i++) {
      if (sidebarNodes[i].online) onlineCount++;
    }
    sidebarStats = {
      total: sidebarNodes.length,
      online: onlineCount,
      offline: sidebarNodes.length - onlineCount
    };
  }
%>
<aside class="side-panel" id="sidePanel">
  <div class="side-panel-section">
    <div class="side-panel-section-header">Nodes (<%= sidebarStats.total %>)</div>
    <div class="side-panel-section-content">
      <ul class="node-tree">
        <%
        // Render node tree recursively
        function renderNodeTree(nodeList, level) {
          nodeList.forEach(function(node, index) {
        %>
          <li class="node-tree-item">
            <a href="/nodes/<%= node.id %>" class="node-tree-row" data-level="<%= level %>">
              <span class="node-tree-status <%= node.online ? 'online' : 'offline' %>"></span>
              <span class="node-tree-name"><%= node.name %></span>
              <% if (node.child_count > 0) { %>
                <span class="node-tree-children-count"><%= node.child_count %></span>
              <% } %>
            </a>
            <% if (node.children && node.children.length > 0) { %>
              <ul class="node-tree">
                <% renderNodeTree(node.children, level + 1); %>
              </ul>
            <% } %>
          </li>
        <%
          });
        }

        // Use tree structure if available, otherwise flat list
        if (sidebarTree.length > 0) {
          renderNodeTree(sidebarTree, 0);
        } else {
          sidebarNodes.forEach(function(node) {
        %>
          <li class="node-tree-item">
            <a href="/nodes/<%= node.id %>" class="node-tree-row" data-level="0">
              <span class="node-tree-status <%= node.online ? 'online' : 'offline' %>"></span>
              <span class="node-tree-name"><%= node.name %></span>
            </a>
          </li>
        <%
          });
        }
        %>
      </ul>
    </div>
  </div>

  <div class="side-panel-section">
    <div class="side-panel-section-header">Tags</div>
    <div class="side-panel-section-content">
      <div class="side-panel-tags">
        <% if (sidebarTags.length > 0) { %>
          <%
            var activeTag = typeof tagFilter !== 'undefined' ? tagFilter : null;
          %>
          <% if (activeTag) { %>
            <a href="/" class="tag tag-clear" title="Filter entfernen">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
              </svg>
              Alle
            </a>
          <% } %>
          <% sidebarTags.forEach(function(tag) {
            var isActive = activeTag === tag.name;
          %>
            <a href="/?tag=<%= encodeURIComponent(tag.name) %>" class="tag tag-link <%= isActive ? 'active' : '' %>" style="--tag-color: <%= tag.color %>;" title="Nach '<%= tag.name %>' filtern"><%= tag.name %></a>
          <% }); %>
        <% } else { %>
          <span class="empty">Keine Tags</span>
        <% } %>
      </div>
    </div>
  </div>

  <div class="side-panel-section">
    <div class="side-panel-section-header">Quick Links</div>
    <div class="side-panel-section-content">
      <ul class="node-tree">
        <li class="node-tree-item">
          <a href="/nodes/add" class="node-tree-row">
            <span style="margin-right: 0.5rem;">+</span>
            <span class="node-tree-name">Node hinzufuegen</span>
          </a>
        </li>
        <li class="node-tree-item">
          <a href="/alerts" class="node-tree-row">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 0.5rem;">
              <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
              <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
            </svg>
            <span class="node-tree-name">Alerts</span>
          </a>
        </li>
        <li class="node-tree-item">
          <a href="/settings" class="node-tree-row">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 0.5rem;">
              <circle cx="12" cy="12" r="3"/>
              <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
            </svg>
            <span class="node-tree-name">Einstellungen</span>
          </a>
        </li>
      </ul>
    </div>
  </div>

  <!-- App Info -->
  <div class="side-panel-footer">
    <div class="side-panel-footer-text">nodepulse v0.3.1</div>
    <div class="side-panel-footer-text">by OidaNice</div>
  </div>
</aside>
