<%
  // Default values for sidebar data
  var sidebarNodes = typeof nodes !== 'undefined' ? nodes : [];
  var sidebarTree = typeof nodeTree !== 'undefined' ? nodeTree : [];
  var sidebarStats = typeof stats !== 'undefined' ? stats : { total: sidebarNodes.length, online: 0, offline: 0 };
  var sidebarTags = typeof tags !== 'undefined' ? tags : [];

  // Build stats lookup from nodesWithStats (for mini-bars)
  var nodeStatsMap = {};
  if (typeof nodesWithStats !== 'undefined' && nodesWithStats) {
    for (var i = 0; i < nodesWithStats.length; i++) {
      nodeStatsMap[nodesWithStats[i].id] = nodesWithStats[i];
    }
  }

  // Helper to get CSS class for percentage
  function getBarClass(percent) {
    if (percent >= 80) return 'critical';
    if (percent >= 60) return 'warning';
    return '';
  }

  // Calculate stats if not provided
  if (!sidebarStats.total && sidebarNodes.length > 0) {
    var onlineCount = 0;
    for (var j = 0; j < sidebarNodes.length; j++) {
      if (sidebarNodes[j].online) onlineCount++;
    }
    sidebarStats = {
      total: sidebarNodes.length,
      online: onlineCount,
      offline: sidebarNodes.length - onlineCount
    };
  }
%>
<aside class="side-panel" id="sidePanel">
  <!-- Search Input -->
  <div class="side-panel-search">
    <input type="text"
           placeholder="Suche... (/)"
           id="sidebarSearch"
           aria-label="Nodes durchsuchen">
    <button type="button" class="btn btn-primary btn-sm" onclick="openAddNodePanel()" title="Node hinzufuegen">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
      </svg>
    </button>
  </div>

  <div class="side-panel-section">
    <div class="side-panel-section-header">
      <span class="side-panel-section-title">Nodes (<%= sidebarStats.total %>)</span>
      <span class="side-panel-stats">
        <span class="stat-online"><%= sidebarStats.online %></span>
        <span class="stat-offline"><%= sidebarStats.offline %></span>
      </span>
    </div>
    <div class="side-panel-section-content">
      <ul class="node-tree">
        <%
        // Helper to get node type icon
        function getNodeTypeIcon(node) {
          if (node.guest_type === 'vm') return '<span class="node-icon vm" title="VM">&#128187;</span>';
          if (node.guest_type === 'lxc') return '<span class="node-icon lxc" title="LXC">&#128230;</span>';
          if (node.node_type === 'proxmox') return '<span class="node-icon proxmox" title="Proxmox">&#127968;</span>';
          return '<span class="node-icon server" title="Server">&#128421;</span>';
        }

        // Render node tree recursively
        function renderNodeTree(nodeList, level) {
          nodeList.forEach(function(node, index) {
            var nStats = nodeStatsMap[node.id] || {};
            var cpuPct = Math.round(nStats.cpu_percent || 0);
            var ramPct = Math.round(nStats.ram_percent || 0);
            var hasChildren = node.children && node.children.length > 0;
            var childCount = node.child_count || (hasChildren ? node.children.length : 0);
        %>
          <li class="node-tree-item<%= hasChildren ? ' has-children' : '' %>" data-node-id="<%= node.id %>">
            <div class="node-tree-row-wrapper">
              <% if (hasChildren) { %>
              <button type="button" class="node-tree-toggle" data-target="children-<%= node.id %>" aria-expanded="false" aria-label="Kinder ein-/ausblenden">
                <svg class="toggle-chevron" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="9 18 15 12 9 6"/>
                </svg>
              </button>
              <% } else { %>
              <span class="node-tree-toggle-placeholder"></span>
              <% } %>
              <a href="/nodes/<%= node.id %>" class="node-tree-row" data-level="<%= level %>">
                <span class="node-tree-status <%= node.online ? 'online' : 'offline' %>"></span>
                <%- getNodeTypeIcon(node) %>
                <span class="node-tree-name"><%= node.name %></span>
                <% if (node.guest_type) { %>
                  <span class="node-tree-guest-badge <%= node.guest_type %>"><%= node.guest_type.toUpperCase() %></span>
                <% } %>
                <% if (childCount > 0) { %>
                  <span class="node-tree-children-count" title="<%= childCount %> Child-Nodes"><%= childCount %></span>
                <% } %>
                <% if (node.online) { %>
                <span class="node-tree-mini-bars">
                  <span class="mini-bar" title="CPU: <%= cpuPct %>%">
                    <span class="mini-bar-fill cpu <%= getBarClass(cpuPct) %>" style="width: <%= Math.max(cpuPct, 2) %>%;"></span>
                  </span>
                  <span class="mini-bar" title="RAM: <%= ramPct %>%">
                    <span class="mini-bar-fill ram <%= getBarClass(ramPct) %>" style="width: <%= Math.max(ramPct, 2) %>%;"></span>
                  </span>
                </span>
                <% } %>
              </a>
            </div>
            <% if (hasChildren) { %>
              <ul class="node-tree node-tree-children" id="children-<%= node.id %>" style="display: none;">
                <% renderNodeTree(node.children, level + 1); %>
              </ul>
            <% } %>
          </li>
        <%
          });
        }

        // Use tree structure if available, otherwise flat list
        if (sidebarTree.length > 0) {
          renderNodeTree(sidebarTree, 0);
        } else {
          sidebarNodes.forEach(function(node) {
            var nStats = nodeStatsMap[node.id] || {};
            var cpuPct = Math.round(nStats.cpu_percent || 0);
            var ramPct = Math.round(nStats.ram_percent || 0);
        %>
          <li class="node-tree-item">
            <a href="/nodes/<%= node.id %>" class="node-tree-row" data-level="0">
              <span class="node-tree-status <%= node.online ? 'online' : 'offline' %>"></span>
              <span class="node-tree-name"><%= node.name %></span>
              <% if (node.online) { %>
              <span class="node-tree-mini-bars">
                <span class="mini-bar" title="CPU: <%= cpuPct %>%">
                  <span class="mini-bar-fill cpu <%= getBarClass(cpuPct) %>" style="width: <%= Math.max(cpuPct, 2) %>%;"></span>
                </span>
                <span class="mini-bar" title="RAM: <%= ramPct %>%">
                  <span class="mini-bar-fill ram <%= getBarClass(ramPct) %>" style="width: <%= Math.max(ramPct, 2) %>%;"></span>
                </span>
              </span>
              <% } %>
            </a>
          </li>
        <%
          });
        }
        %>
      </ul>
    </div>
  </div>

  <div class="side-panel-section">
    <div class="side-panel-section-header">
      <span class="side-panel-section-title">Tags</span>
    </div>
    <div class="side-panel-section-content">
      <div class="side-panel-tags">
        <% if (sidebarTags.length > 0) { %>
          <%
            var activeTag = typeof tagFilter !== 'undefined' ? tagFilter : null;
          %>
          <% if (activeTag) { %>
            <a href="/" class="tag tag-clear" title="Filter entfernen">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
              </svg>
              Alle
            </a>
          <% } %>
          <% sidebarTags.forEach(function(tag) {
            var isActive = activeTag === tag.name;
          %>
            <a href="/?tag=<%= encodeURIComponent(tag.name) %>" class="tag tag-link <%= isActive ? 'active' : '' %>" style="--tag-color: <%= tag.color %>;" title="Nach '<%= tag.name %>' filtern"><%= tag.name %></a>
          <% }); %>
        <% } else { %>
          <span class="empty">Keine Tags</span>
        <% } %>
      </div>
    </div>
  </div>

  <!-- App Info -->
  <div class="side-panel-footer">
    <div class="side-panel-footer-text">nodepulse v0.6.0</div>
    <div class="side-panel-footer-text">by OidaNice</div>
  </div>
</aside>
<script src="/static/js/sidebar.js"></script>
