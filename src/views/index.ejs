<%- include('partials/header', { currentPath: '/' }) %>

<div class="app-layout">
  <!-- Side Panel (Desktop: sichtbar, Mobile: hidden) -->
  <aside class="side-panel" id="sidePanel">
    <div class="side-panel-section">
      <div class="side-panel-section-header">Nodes (<%= stats.total %>)</div>
      <div class="side-panel-section-content">
        <ul class="node-tree">
          <%
          // Render node tree recursively
          function renderNodeTree(nodeList, level) {
            nodeList.forEach(function(node, index) {
              var isLast = index === nodeList.length - 1;
          %>
            <li class="node-tree-item">
              <a href="/nodes/<%= node.id %>" class="node-tree-row" data-level="<%= level %>">
                <span class="node-tree-status <%= node.online ? 'online' : 'offline' %>"></span>
                <span class="node-tree-name"><%= node.name %></span>
                <% if (node.child_count > 0) { %>
                  <span class="node-tree-children-count"><%= node.child_count %></span>
                <% } %>
              </a>
              <% if (node.children && node.children.length > 0) { %>
                <ul class="node-tree">
                  <% renderNodeTree(node.children, level + 1); %>
                </ul>
              <% } %>
            </li>
          <%
            });
          }

          // Use tree structure if available, otherwise flat list
          if (typeof nodeTree !== 'undefined' && nodeTree.length > 0) {
            renderNodeTree(nodeTree, 0);
          } else {
            nodes.forEach(function(node) {
          %>
            <li class="node-tree-item">
              <a href="/nodes/<%= node.id %>" class="node-tree-row" data-level="0">
                <span class="node-tree-status <%= node.online ? 'online' : 'offline' %>"></span>
                <span class="node-tree-name"><%= node.name %></span>
              </a>
            </li>
          <%
            });
          }
          %>
        </ul>
      </div>
    </div>

    <div class="side-panel-section">
      <div class="side-panel-section-header">Tags</div>
      <div class="side-panel-section-content">
        <div style="padding: 0.5rem 1rem;">
          <% if (typeof tags !== 'undefined' && tags.length > 0) { %>
            <% tags.forEach(function(tag) { %>
              <span class="tag" style="background-color: <%= tag.color %>20; border: 1px solid <%= tag.color %>; margin: 0.25rem;"><%= tag.name %></span>
            <% }); %>
          <% } else { %>
            <span class="empty">Keine Tags</span>
          <% } %>
        </div>
      </div>
    </div>

    <div class="side-panel-section">
      <div class="side-panel-section-header">Quick Links</div>
      <div class="side-panel-section-content">
        <ul class="node-tree">
          <li class="node-tree-item">
            <a href="/nodes/add" class="node-tree-row">
              <span style="margin-right: 0.5rem;">+</span>
              <span class="node-tree-name">Node hinzufügen</span>
            </a>
          </li>
          <li class="node-tree-item">
            <a href="/settings" class="node-tree-row">
              <span style="margin-right: 0.5rem;">⚙</span>
              <span class="node-tree-name">Einstellungen</span>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main-panel">
    <!-- Stats Cards -->
    <div class="stats-cards">
      <div class="stats-card">
        <span class="stats-card-value"><%= stats.total %></span>
        <span class="stats-card-label">Nodes</span>
      </div>
      <div class="stats-card stats-card-online">
        <span class="stats-card-icon">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none">
            <circle cx="12" cy="12" r="10" fill="#10B981"/>
            <path d="M8 12L11 15L16 9" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </span>
        <span class="stats-card-value online"><%= stats.online %></span>
        <span class="stats-card-label">Online</span>
      </div>
      <div class="stats-card stats-card-offline">
        <span class="stats-card-icon">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none">
            <circle cx="12" cy="12" r="10" fill="#EF4444"/>
            <path d="M15 9L9 15M9 9L15 15" stroke="white" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </span>
        <span class="stats-card-value offline"><%= stats.offline %></span>
        <span class="stats-card-label">Offline</span>
      </div>
      <div class="stats-cards-actions">
        <a href="/nodes/add" class="btn btn-primary">+ Node</a>
      </div>
    </div>

    <% if (nodes.length === 0) { %>
      <div class="empty-state" style="text-align: center; padding: 3rem;">
        <p style="color: var(--color-text-muted); margin-bottom: 1rem;">Noch keine Nodes vorhanden.</p>
        <a href="/nodes/add" class="btn btn-primary">Ersten Node hinzufügen</a>
      </div>
    <% } else { %>
      <!-- Search/Filter Bar -->
      <div class="node-list-filter">
        <input type="text" id="nodeSearchInput" class="node-list-search" placeholder="Nodes suchen..." onkeyup="filterNodes()">
        <select id="nodeTypeFilter" class="node-list-type-select" onchange="filterNodes()">
          <option value="">Alle Typen</option>
          <option value="proxmox-host">Proxmox</option>
          <option value="docker-host">Docker</option>
          <option value="raspberry-pi">Raspberry Pi</option>
          <option value="linux">Linux</option>
          <option value="windows">Windows</option>
        </select>
        <select id="nodeStatusFilter" class="node-list-status-select" onchange="filterNodes()">
          <option value="">Alle Status</option>
          <option value="online">Online</option>
          <option value="offline">Offline</option>
        </select>
      </div>

      <!-- Flat Node List with Hierarchy -->
      <div class="node-list" id="nodeList">
        <div class="node-list-header">
          <div class="node-list-col-status"></div>
          <div class="node-list-col-icon"></div>
          <div class="node-list-col-name">Name</div>
          <div class="node-list-col-host">Host</div>
          <div class="node-list-col-type">Typ</div>
          <div class="node-list-col-actions"></div>
        </div>

        <%
        // Render flat list with hierarchy indication
        function renderNodeList(nodeList, level) {
          nodeList.forEach(function(node) {
        %>
          <div class="node-list-row<%= level > 0 ? ' child-level-' + level : '' %>"
               data-name="<%= node.name.toLowerCase() %>"
               data-type="<%= node.node_type || 'unknown' %>"
               data-status="<%= node.online ? 'online' : 'offline' %>">
            <div class="node-list-status">
              <span class="node-list-status-dot <%= node.online ? 'online' : 'offline' %>"></span>
            </div>
            <div class="node-list-icon">
              <%- include('partials/node-type-icon', { nodeType: node.node_type || 'unknown', size: 22 }) %>
            </div>
            <div class="node-list-name">
              <a href="/nodes/<%= node.id %>"><%= node.name %></a>
              <span class="node-list-host-mobile"><%= node.host %></span>
            </div>
            <div class="node-list-host"><%= node.host %></div>
            <div class="node-list-type"><span class="node-type-badge <%= node.node_type || 'unknown' %>"><%= node.node_type || 'unknown' %></span></div>
            <div class="node-list-actions">
              <a href="/nodes/<%= node.id %>" class="node-list-action" title="Details">
                <span class="icon-arrow"></span>
              </a>
            </div>
          </div>
          <%
            if (node.children && node.children.length > 0) {
              renderNodeList(node.children, level + 1);
            }
          });
        }

        // Use tree structure if available
        if (typeof nodeTree !== 'undefined' && nodeTree.length > 0) {
          renderNodeList(nodeTree, 0);
        } else {
          // Fallback: flat list
          nodes.forEach(function(node) {
        %>
          <div class="node-list-row"
               data-name="<%= node.name.toLowerCase() %>"
               data-type="<%= node.node_type || 'unknown' %>"
               data-status="<%= node.online ? 'online' : 'offline' %>">
            <div class="node-list-status">
              <span class="node-list-status-dot <%= node.online ? 'online' : 'offline' %>"></span>
            </div>
            <div class="node-list-icon">
              <%- include('partials/node-type-icon', { nodeType: node.node_type || 'unknown', size: 22 }) %>
            </div>
            <div class="node-list-name">
              <a href="/nodes/<%= node.id %>"><%= node.name %></a>
              <span class="node-list-host-mobile"><%= node.host %></span>
            </div>
            <div class="node-list-host"><%= node.host %></div>
            <div class="node-list-type"><span class="node-type-badge <%= node.node_type || 'unknown' %>"><%= node.node_type || 'unknown' %></span></div>
            <div class="node-list-actions">
              <a href="/nodes/<%= node.id %>" class="node-list-action" title="Details">
                <span class="icon-arrow"></span>
              </a>
            </div>
          </div>
        <%
          });
        }
        %>
      </div>

      <!-- Filter Results Counter -->
      <div class="node-list-counter" id="nodeListCounter">
        <span id="visibleCount"><%= nodes.length %></span> / <%= nodes.length %> Nodes
      </div>

<script>
// ES5 Node Filter Function
function filterNodes() {
  var searchInput = document.getElementById('nodeSearchInput');
  var typeFilter = document.getElementById('nodeTypeFilter');
  var statusFilter = document.getElementById('nodeStatusFilter');
  var rows = document.querySelectorAll('.node-list-row');
  var visibleCount = 0;

  var searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
  var typeValue = typeFilter ? typeFilter.value : '';
  var statusValue = statusFilter ? statusFilter.value : '';

  for (var i = 0; i < rows.length; i++) {
    var row = rows[i];
    var name = row.getAttribute('data-name') || '';
    var type = row.getAttribute('data-type') || '';
    var status = row.getAttribute('data-status') || '';

    var matchesSearch = name.indexOf(searchTerm) > -1;
    var matchesType = !typeValue || type === typeValue;
    var matchesStatus = !statusValue || status === statusValue;

    if (matchesSearch && matchesType && matchesStatus) {
      row.style.display = '';
      visibleCount++;
    } else {
      row.style.display = 'none';
    }
  }

  var counterEl = document.getElementById('visibleCount');
  if (counterEl) {
    counterEl.textContent = visibleCount;
  }
}
</script>
    <% } %>
  </main>
</div>

<%- include('partials/footer') %>
