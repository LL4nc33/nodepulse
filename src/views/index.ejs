<%- include('partials/header', { currentPath: '/' }) %>

<div class="app-layout">
  <%- include('partials/side-panel') %>

  <!-- Main Content -->
  <main class="main-panel">
    <!-- Stats Cards -->
    <div class="stats-cards">
      <div class="stats-card">
        <span class="stats-card-value"><%= stats.total %></span>
        <span class="stats-card-label">Nodes</span>
      </div>
      <div class="stats-card stats-card-online">
        <span class="stats-card-icon">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none">
            <circle cx="12" cy="12" r="10" fill="#10B981"/>
            <path d="M8 12L11 15L16 9" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </span>
        <span class="stats-card-value online"><%= stats.online %></span>
        <span class="stats-card-label">Online</span>
      </div>
      <div class="stats-card stats-card-offline">
        <span class="stats-card-icon">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none">
            <circle cx="12" cy="12" r="10" fill="#EF4444"/>
            <path d="M15 9L9 15M9 9L15 15" stroke="white" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </span>
        <span class="stats-card-value offline"><%= stats.offline %></span>
        <span class="stats-card-label">Offline</span>
      </div>
      <div class="stats-cards-actions">
        <a href="/nodes/add" class="btn btn-primary">+ Node</a>
      </div>
    </div>

    <% if (nodes.length === 0) { %>
      <div class="empty-state">
        <div class="empty-state-icon">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <rect x="2" y="3" width="20" height="14" rx="2"/>
            <line x1="8" y1="21" x2="16" y2="21"/>
            <line x1="12" y1="17" x2="12" y2="21"/>
            <circle cx="12" cy="10" r="2"/>
          </svg>
        </div>
        <div class="empty-state-title">Keine Nodes vorhanden</div>
        <p class="empty-state-text">Füge deinen ersten Server, Raspberry Pi oder Docker-Host hinzu, um mit dem Monitoring zu starten.</p>
        <a href="/nodes/add" class="btn btn-primary">+ Ersten Node hinzufügen</a>
      </div>
    <% } else { %>
      <!-- Search/Filter Bar -->
      <div class="node-list-filter">
        <input type="text" id="nodeSearchInput" class="node-list-search" placeholder="Nodes suchen..." onkeyup="filterNodesAndCards()">
        <select id="nodeTypeFilter" class="node-list-type-select" onchange="filterNodesAndCards()">
          <option value="">Alle Typen</option>
          <option value="proxmox-host">Proxmox</option>
          <option value="docker-host">Docker</option>
          <option value="raspberry-pi">Raspberry Pi</option>
          <option value="linux">Linux</option>
          <option value="windows">Windows</option>
        </select>
        <select id="nodeStatusFilter" class="node-list-status-select" onchange="filterNodesAndCards()">
          <option value="">Alle Status</option>
          <option value="online">Online</option>
          <option value="offline">Offline</option>
        </select>
        <div class="view-toggle-group">
          <button type="button" class="view-toggle active" id="btnListView" onclick="setViewMode('list')" title="Liste">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/>
              <line x1="3" y1="6" x2="3" y2="6"/><line x1="3" y1="12" x2="3" y2="12"/><line x1="3" y1="18" x2="3" y2="18"/>
            </svg>
          </button>
          <button type="button" class="view-toggle" id="btnCardsView" onclick="setViewMode('cards')" title="Karten">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/>
              <rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/>
            </svg>
          </button>
          <button type="button" class="view-toggle" id="btnTreeView" onclick="setViewMode('tree')" title="Baum">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 9l4-4l4 4"/><path d="M7 5v14"/><path d="M11 12h6"/><path d="M11 16h4"/>
            </svg>
          </button>
        </div>
      </div>

      <!-- Flat Node List with Hierarchy -->
      <div class="node-list" id="nodeList">
        <div class="node-list-header">
          <div class="node-list-col-status"></div>
          <div class="node-list-col-icon"></div>
          <div class="node-list-col-name">Name</div>
          <div class="node-list-col-host">Host</div>
          <div class="node-list-col-metrics">CPU</div>
          <div class="node-list-col-metrics">RAM</div>
          <div class="node-list-col-metrics">Disk</div>
          <div class="node-list-col-type">Typ</div>
          <div class="node-list-col-actions"></div>
        </div>

        <%
        // Create stats lookup map
        var statsMap = {};
        if (typeof nodesWithStats !== 'undefined') {
          nodesWithStats.forEach(function(n) {
            statsMap[n.id] = n;
          });
        }

        // Render flat list with hierarchy indication
        function renderNodeList(nodeList, level) {
          nodeList.forEach(function(node) {
            var stats = statsMap[node.id] || {};
        %>
          <div class="node-list-row<%= level > 0 ? ' child-level-' + level : '' %>"
               data-name="<%= node.name.toLowerCase() %>"
               data-type="<%= node.node_type || 'unknown' %>"
               data-status="<%= node.online ? 'online' : 'offline' %>">
            <div class="node-list-status">
              <span class="node-list-status-dot <%= node.online ? 'online' : 'offline' %>"></span>
            </div>
            <div class="node-list-icon">
              <%- include('partials/node-type-icon', { nodeType: node.node_type || 'unknown', size: 22 }) %>
            </div>
            <div class="node-list-name">
              <a href="/nodes/<%= node.id %>"><%= node.name %></a>
              <span class="node-list-host-mobile"><%= node.host %></span>
            </div>
            <div class="node-list-host"><%= node.host %></div>
            <div class="node-list-metric">
              <% if (node.online && stats.cpu_percent !== null && stats.cpu_percent !== undefined) { %>
              <div class="mini-bar">
                <div class="mini-bar-fill <%= (stats.cpu_percent || 0) >= 95 ? 'critical' : ((stats.cpu_percent || 0) >= 80 ? 'warning' : 'ok') %>" style="width: <%= Math.min(stats.cpu_percent || 0, 100) %>%"></div>
              </div>
              <span class="mini-bar-value"><%= Math.round(stats.cpu_percent) %>%</span>
              <% } else { %><span class="mini-bar-na">-</span><% } %>
            </div>
            <div class="node-list-metric">
              <% if (node.online && stats.ram_percent !== null && stats.ram_percent !== undefined) { %>
              <div class="mini-bar">
                <div class="mini-bar-fill <%= (stats.ram_percent || 0) >= 95 ? 'critical' : ((stats.ram_percent || 0) >= 85 ? 'warning' : 'ok') %>" style="width: <%= Math.min(stats.ram_percent || 0, 100) %>%"></div>
              </div>
              <span class="mini-bar-value"><%= Math.round(stats.ram_percent) %>%</span>
              <% } else { %><span class="mini-bar-na">-</span><% } %>
            </div>
            <div class="node-list-metric">
              <% if (node.online && stats.disk_percent !== null && stats.disk_percent !== undefined) { %>
              <div class="mini-bar">
                <div class="mini-bar-fill <%= (stats.disk_percent || 0) >= 95 ? 'critical' : ((stats.disk_percent || 0) >= 80 ? 'warning' : 'ok') %>" style="width: <%= Math.min(stats.disk_percent || 0, 100) %>%"></div>
              </div>
              <span class="mini-bar-value"><%= Math.round(stats.disk_percent) %>%</span>
              <% } else { %><span class="mini-bar-na">-</span><% } %>
            </div>
            <div class="node-list-type"><span class="node-type-badge <%= node.node_type || 'unknown' %>"><%= node.node_type || 'unknown' %></span></div>
            <div class="node-list-actions">
              <a href="/nodes/<%= node.id %>" class="node-list-action" title="Details">
                <span class="icon-arrow"></span>
              </a>
            </div>
          </div>
          <%
            if (node.children && node.children.length > 0) {
              renderNodeList(node.children, level + 1);
            }
          });
        }

        // Use tree structure if available
        if (typeof nodeTree !== 'undefined' && nodeTree.length > 0) {
          renderNodeList(nodeTree, 0);
        } else {
          // Fallback: flat list
          nodes.forEach(function(node) {
            var stats = statsMap[node.id] || {};
        %>
          <div class="node-list-row"
               data-name="<%= node.name.toLowerCase() %>"
               data-type="<%= node.node_type || 'unknown' %>"
               data-status="<%= node.online ? 'online' : 'offline' %>">
            <div class="node-list-status">
              <span class="node-list-status-dot <%= node.online ? 'online' : 'offline' %>"></span>
            </div>
            <div class="node-list-icon">
              <%- include('partials/node-type-icon', { nodeType: node.node_type || 'unknown', size: 22 }) %>
            </div>
            <div class="node-list-name">
              <a href="/nodes/<%= node.id %>"><%= node.name %></a>
              <span class="node-list-host-mobile"><%= node.host %></span>
            </div>
            <div class="node-list-host"><%= node.host %></div>
            <div class="node-list-metric">
              <% if (node.online && stats.cpu_percent !== null && stats.cpu_percent !== undefined) { %>
              <div class="mini-bar">
                <div class="mini-bar-fill <%= (stats.cpu_percent || 0) >= 95 ? 'critical' : ((stats.cpu_percent || 0) >= 80 ? 'warning' : 'ok') %>" style="width: <%= Math.min(stats.cpu_percent || 0, 100) %>%"></div>
              </div>
              <span class="mini-bar-value"><%= Math.round(stats.cpu_percent) %>%</span>
              <% } else { %><span class="mini-bar-na">-</span><% } %>
            </div>
            <div class="node-list-metric">
              <% if (node.online && stats.ram_percent !== null && stats.ram_percent !== undefined) { %>
              <div class="mini-bar">
                <div class="mini-bar-fill <%= (stats.ram_percent || 0) >= 95 ? 'critical' : ((stats.ram_percent || 0) >= 85 ? 'warning' : 'ok') %>" style="width: <%= Math.min(stats.ram_percent || 0, 100) %>%"></div>
              </div>
              <span class="mini-bar-value"><%= Math.round(stats.ram_percent) %>%</span>
              <% } else { %><span class="mini-bar-na">-</span><% } %>
            </div>
            <div class="node-list-metric">
              <% if (node.online && stats.disk_percent !== null && stats.disk_percent !== undefined) { %>
              <div class="mini-bar">
                <div class="mini-bar-fill <%= (stats.disk_percent || 0) >= 95 ? 'critical' : ((stats.disk_percent || 0) >= 80 ? 'warning' : 'ok') %>" style="width: <%= Math.min(stats.disk_percent || 0, 100) %>%"></div>
              </div>
              <span class="mini-bar-value"><%= Math.round(stats.disk_percent) %>%</span>
              <% } else { %><span class="mini-bar-na">-</span><% } %>
            </div>
            <div class="node-list-type"><span class="node-type-badge <%= node.node_type || 'unknown' %>"><%= node.node_type || 'unknown' %></span></div>
            <div class="node-list-actions">
              <a href="/nodes/<%= node.id %>" class="node-list-action" title="Details">
                <span class="icon-arrow"></span>
              </a>
            </div>
          </div>
        <%
          });
        }
        %>
      </div>

      <!-- Cards View (Monitoring-Style) -->
      <div class="node-cards-view" id="nodeCardsView" style="display: none;">
        <% if (typeof nodesWithStats !== 'undefined' && nodesWithStats.length > 0) { %>
          <div class="monitoring-grid">
            <% nodesWithStats.forEach(function(node) {
              // Determine status class
              var statusClass = 'offline';
              if (node.online) {
                var maxPercent = Math.max(node.cpu_percent || 0, node.ram_percent || 0, node.disk_percent || 0);
                if (maxPercent >= thresholds.cpu_critical || maxPercent >= thresholds.ram_critical || maxPercent >= thresholds.disk_critical) {
                  statusClass = 'critical';
                } else if (maxPercent >= thresholds.cpu_warning || maxPercent >= thresholds.ram_warning || maxPercent >= thresholds.disk_warning) {
                  statusClass = 'warning';
                } else {
                  statusClass = 'ok';
                }
              }
            %>
            <div class="monitoring-card <%= statusClass %>"
                 data-name="<%= node.name.toLowerCase() %>"
                 data-type="<%= node.node_type || 'unknown' %>"
                 data-status="<%= node.online ? 'online' : 'offline' %>">
              <div class="monitoring-header">
                <a href="/nodes/<%= node.id %>" class="monitoring-name"><%= node.name %></a>
                <span class="monitoring-status <%= node.online ? 'online' : 'offline' %>">
                  <%= node.online ? 'Online' : 'Offline' %>
                </span>
              </div>

              <% if (node.online && (node.cpu_percent !== null || node.ram_percent !== null)) { %>
              <div class="monitoring-stats">
                <!-- CPU -->
                <div class="stat-bar">
                  <div class="stat-bar-label">
                    <span>CPU</span>
                    <span class="stat-bar-value <%= (node.cpu_percent || 0) >= thresholds.cpu_critical ? 'critical' : ((node.cpu_percent || 0) >= thresholds.cpu_warning ? 'warning' : '') %>">
                      <%= node.cpu_percent !== null ? Math.round(node.cpu_percent) + '%' : '-' %>
                    </span>
                  </div>
                  <div class="stat-bar-track">
                    <div class="stat-bar-fill <%= (node.cpu_percent || 0) >= thresholds.cpu_critical ? 'critical' : ((node.cpu_percent || 0) >= thresholds.cpu_warning ? 'warning' : 'ok') %>"
                         style="width: <%= Math.min(node.cpu_percent || 0, 100) %>%"></div>
                  </div>
                </div>

                <!-- RAM -->
                <div class="stat-bar">
                  <div class="stat-bar-label">
                    <span>RAM</span>
                    <span class="stat-bar-value <%= (node.ram_percent || 0) >= thresholds.ram_critical ? 'critical' : ((node.ram_percent || 0) >= thresholds.ram_warning ? 'warning' : '') %>">
                      <%= node.ram_percent !== null ? Math.round(node.ram_percent) + '%' : '-' %>
                    </span>
                  </div>
                  <div class="stat-bar-track">
                    <div class="stat-bar-fill <%= (node.ram_percent || 0) >= thresholds.ram_critical ? 'critical' : ((node.ram_percent || 0) >= thresholds.ram_warning ? 'warning' : 'ok') %>"
                         style="width: <%= Math.min(node.ram_percent || 0, 100) %>%"></div>
                  </div>
                </div>

                <!-- Disk -->
                <div class="stat-bar">
                  <div class="stat-bar-label">
                    <span>Disk</span>
                    <span class="stat-bar-value <%= (node.disk_percent || 0) >= thresholds.disk_critical ? 'critical' : ((node.disk_percent || 0) >= thresholds.disk_warning ? 'warning' : '') %>">
                      <%= node.disk_percent !== null ? Math.round(node.disk_percent) + '%' : '-' %>
                    </span>
                  </div>
                  <div class="stat-bar-track">
                    <div class="stat-bar-fill <%= (node.disk_percent || 0) >= thresholds.disk_critical ? 'critical' : ((node.disk_percent || 0) >= thresholds.disk_warning ? 'warning' : 'ok') %>"
                         style="width: <%= Math.min(node.disk_percent || 0, 100) %>%"></div>
                  </div>
                </div>

                <% if (node.temp_cpu !== null) { %>
                <!-- Temperature -->
                <div class="stat-bar">
                  <div class="stat-bar-label">
                    <span>Temp</span>
                    <span class="stat-bar-value <%= (node.temp_cpu || 0) >= thresholds.temp_critical ? 'critical' : ((node.temp_cpu || 0) >= thresholds.temp_warning ? 'warning' : '') %>">
                      <%= Math.round(node.temp_cpu) %>&deg;C
                    </span>
                  </div>
                </div>
                <% } %>
              </div>

              <div class="monitoring-meta">
                <% if (node.load_1m !== null) { %>
                <span>Load: <%= node.load_1m %></span>
                <% } %>
                <% if (node.uptime_seconds) { %>
                <span>Up: <%= Math.floor(node.uptime_seconds / 86400) %>d</span>
                <% } %>
              </div>
              <% } else { %>
              <div class="monitoring-stats monitoring-stats-offline">
                <p class="monitoring-no-data">Keine Daten verfuegbar</p>
              </div>
              <% } %>
            </div>
            <% }); %>
          </div>
        <% } else { %>
          <div class="empty-state">
            <p>Keine Monitoring-Daten verfuegbar.</p>
          </div>
        <% } %>
      </div>

      <!-- Filter Results Counter -->
      <div class="node-list-counter" id="nodeListCounter">
        <span id="visibleCount"><%= nodes.length %></span> / <%= nodes.length %> Nodes
      </div>

<script>
// ES5 Node Filter Function
function filterNodes() {
  var searchInput = document.getElementById('nodeSearchInput');
  var typeFilter = document.getElementById('nodeTypeFilter');
  var statusFilter = document.getElementById('nodeStatusFilter');
  var rows = document.querySelectorAll('.node-list-row');
  var visibleCount = 0;

  var searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
  var typeValue = typeFilter ? typeFilter.value : '';
  var statusValue = statusFilter ? statusFilter.value : '';

  for (var i = 0; i < rows.length; i++) {
    var row = rows[i];
    var name = row.getAttribute('data-name') || '';
    var type = row.getAttribute('data-type') || '';
    var status = row.getAttribute('data-status') || '';

    var matchesSearch = name.indexOf(searchTerm) > -1;
    var matchesType = !typeValue || type === typeValue;
    var matchesStatus = !statusValue || status === statusValue;

    if (matchesSearch && matchesType && matchesStatus) {
      row.style.display = '';
      visibleCount++;
    } else {
      row.style.display = 'none';
    }
  }

  var counterEl = document.getElementById('visibleCount');
  if (counterEl) {
    counterEl.textContent = visibleCount;
  }
}

// View Mode Toggle (List vs Cards vs Tree)
var currentViewMode = 'list';

function setViewMode(mode) {
  currentViewMode = mode;
  var nodeList = document.getElementById('nodeList');
  var nodeCardsView = document.getElementById('nodeCardsView');
  var nodeListCounter = document.getElementById('nodeListCounter');
  var btnList = document.getElementById('btnListView');
  var btnCards = document.getElementById('btnCardsView');
  var btnTree = document.getElementById('btnTreeView');

  // Reset all buttons
  if (btnList) btnList.classList.remove('active');
  if (btnCards) btnCards.classList.remove('active');
  if (btnTree) btnTree.classList.remove('active');

  // Reset views
  if (nodeList) {
    nodeList.style.display = 'none';
    nodeList.classList.remove('tree-view');
  }
  if (nodeCardsView) nodeCardsView.style.display = 'none';
  if (nodeListCounter) nodeListCounter.style.display = 'none';

  if (mode === 'cards') {
    if (nodeCardsView) nodeCardsView.style.display = 'block';
    if (btnCards) btnCards.classList.add('active');
  } else if (mode === 'tree') {
    if (nodeList) {
      nodeList.style.display = 'block';
      nodeList.classList.add('tree-view');
    }
    if (nodeListCounter) nodeListCounter.style.display = 'block';
    if (btnTree) btnTree.classList.add('active');
  } else {
    // Default: list
    if (nodeList) nodeList.style.display = 'block';
    if (nodeListCounter) nodeListCounter.style.display = 'block';
    if (btnList) btnList.classList.add('active');
  }

  // Save preference
  try { localStorage.setItem('dashboard-view-mode', mode); } catch (e) {}
}

// Filter also works on cards
function filterNodesAndCards() {
  filterNodes();

  // Also filter cards view
  var searchInput = document.getElementById('nodeSearchInput');
  var typeFilter = document.getElementById('nodeTypeFilter');
  var statusFilter = document.getElementById('nodeStatusFilter');
  var cards = document.querySelectorAll('.monitoring-card');

  var searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
  var typeValue = typeFilter ? typeFilter.value : '';
  var statusValue = statusFilter ? statusFilter.value : '';

  for (var i = 0; i < cards.length; i++) {
    var card = cards[i];
    var name = card.getAttribute('data-name') || '';
    var type = card.getAttribute('data-type') || '';
    var status = card.getAttribute('data-status') || '';

    var matchesSearch = name.indexOf(searchTerm) > -1;
    var matchesType = !typeValue || type === typeValue;
    var matchesStatus = !statusValue || status === statusValue;

    if (matchesSearch && matchesType && matchesStatus) {
      card.style.display = '';
    } else {
      card.style.display = 'none';
    }
  }
}

// Restore view mode on load
(function() {
  try {
    var savedMode = localStorage.getItem('dashboard-view-mode');
    if (savedMode === 'cards' || savedMode === 'tree') {
      setViewMode(savedMode);
    }
  } catch (e) {}
})();
</script>
    <% } %>
  </main>
</div>

<%- include('partials/footer') %>
