<%- include('partials/header', { currentPath: '/' }) %>

<div class="app-layout">
  <%- include('partials/side-panel') %>

  <!-- Main Content -->
  <main class="main-panel" id="main-content">
    <% if (typeof clusterResources !== 'undefined' && clusterResources) { %>
    <!-- Cluster Bar (kompakt) -->
    <div class="cluster-bar">
      <div class="cluster-stats">
        <span class="stat-total"><%= stats.total %> Nodes</span>
        <span class="stat-online"><%= stats.online %> Online</span>
        <span class="stat-offline"><%= stats.offline %> Offline</span>
      </div>
      <div class="cluster-resources">
        <% if (clusterResources.cpu) { %>
        <div class="resource-metric">
          <span class="label">CPU</span>
          <div class="metric-bar-compact">
            <div class="fill <%= clusterResources.cpu > 80 ? 'critical' : (clusterResources.cpu > 60 ? 'warning' : 'ok') %>" style="width:<%= clusterResources.cpu %>%"></div>
            <span class="value" id="cluster-cpu-value"><%= clusterResources.cpu %>%</span>
          </div>
          <canvas id="cluster-sparkline-cpu" class="cluster-sparkline" width="60" height="20"></canvas>
        </div>
        <% } %>
        <% if (clusterResources.memory) { %>
        <div class="resource-metric">
          <span class="label">RAM</span>
          <div class="metric-bar-compact">
            <div class="fill <%= clusterResources.memory > 80 ? 'critical' : (clusterResources.memory > 60 ? 'warning' : 'ok') %>" style="width:<%= clusterResources.memory %>%"></div>
            <span class="value" id="cluster-ram-value"><%= clusterResources.memory %>%</span>
          </div>
          <canvas id="cluster-sparkline-ram" class="cluster-sparkline" width="60" height="20"></canvas>
        </div>
        <% } %>
        <% if (clusterResources.storage) { %>
        <div class="resource-metric">
          <span class="label">Disk</span>
          <div class="metric-bar-compact">
            <div class="fill <%= clusterResources.storage > 80 ? 'critical' : (clusterResources.storage > 60 ? 'warning' : 'ok') %>" style="width:<%= clusterResources.storage %>%"></div>
            <span class="value" id="cluster-disk-value"><%= clusterResources.storage %>%</span>
          </div>
          <canvas id="cluster-sparkline-disk" class="cluster-sparkline" width="60" height="20"></canvas>
        </div>
        <% } %>
      </div>
    </div>
    <% } else { %>
    <!-- Cluster Summary (Proxmox-Style) - Fallback -->
    <div class="cluster-summary" role="region" aria-label="Cluster-Zusammenfassung">
      <!-- Node Status -->
      <div class="cluster-section cluster-nodes">
        <div class="cluster-stat">
          <span class="cluster-stat-value"><%= stats.total %></span>
          <span class="cluster-stat-label">Nodes</span>
        </div>
        <div class="cluster-stat cluster-stat-online">
          <span class="cluster-stat-dot online"></span>
          <span class="cluster-stat-value"><%= stats.online %></span>
          <span class="cluster-stat-label">Online</span>
        </div>
        <div class="cluster-stat cluster-stat-offline">
          <span class="cluster-stat-dot offline"></span>
          <span class="cluster-stat-value"><%= stats.offline %></span>
          <span class="cluster-stat-label">Offline</span>
        </div>
      </div>

      <!-- CPU Summary -->
      <div class="cluster-section cluster-metric">
        <div class="cluster-metric-header">
          <span class="cluster-metric-label">CPU</span>
          <span class="cluster-metric-value <%= clusterStats.usedCpuPercent >= 95 ? 'critical' : clusterStats.usedCpuPercent >= 80 ? 'warning' : '' %>">
            <%= clusterStats.usedCpuPercent %>%
          </span>
        </div>
        <div class="cluster-metric-bar">
          <div class="cluster-metric-fill <%= clusterStats.usedCpuPercent >= 95 ? 'critical' : clusterStats.usedCpuPercent >= 80 ? 'warning' : 'ok' %>"
               style="width: <%= Math.min(clusterStats.usedCpuPercent, 100) %>%"></div>
        </div>
        <span class="cluster-metric-detail"><%= clusterStats.totalCpuCores %> cores</span>
      </div>

      <!-- RAM Summary -->
      <div class="cluster-section cluster-metric">
        <div class="cluster-metric-header">
          <span class="cluster-metric-label">Memory</span>
          <span class="cluster-metric-value <%= clusterStats.usedRamPercent >= 95 ? 'critical' : clusterStats.usedRamPercent >= 85 ? 'warning' : '' %>">
            <%= clusterStats.usedRamPercent %>%
          </span>
        </div>
        <div class="cluster-metric-bar">
          <div class="cluster-metric-fill <%= clusterStats.usedRamPercent >= 95 ? 'critical' : clusterStats.usedRamPercent >= 85 ? 'warning' : 'ok' %>"
               style="width: <%= Math.min(clusterStats.usedRamPercent, 100) %>%"></div>
        </div>
        <span class="cluster-metric-detail"><%= formatBytes(clusterStats.usedRamBytes) %> / <%= formatBytes(clusterStats.totalRamBytes) %></span>
      </div>

      <!-- Disk Summary -->
      <div class="cluster-section cluster-metric">
        <div class="cluster-metric-header">
          <span class="cluster-metric-label">Storage</span>
          <span class="cluster-metric-value <%= clusterStats.usedDiskPercent >= 95 ? 'critical' : clusterStats.usedDiskPercent >= 80 ? 'warning' : '' %>">
            <%= clusterStats.usedDiskPercent %>%
          </span>
        </div>
        <div class="cluster-metric-bar">
          <div class="cluster-metric-fill <%= clusterStats.usedDiskPercent >= 95 ? 'critical' : clusterStats.usedDiskPercent >= 80 ? 'warning' : 'ok' %>"
               style="width: <%= Math.min(clusterStats.usedDiskPercent, 100) %>%"></div>
        </div>
        <span class="cluster-metric-detail"><%= formatBytes(clusterStats.usedDiskBytes) %> / <%= formatBytes(clusterStats.totalDiskBytes) %></span>
      </div>

      <!-- VMs & Containers -->
      <div class="cluster-section cluster-counts">
        <div class="cluster-count">
          <span class="cluster-count-value"><%= clusterStats.totalVMs %></span>
          <span class="cluster-count-label">VMs</span>
        </div>
        <div class="cluster-count">
          <span class="cluster-count-value"><%= clusterStats.totalContainers %></span>
          <span class="cluster-count-label">Container</span>
        </div>
      </div>

      <!-- Actions -->
      <div class="cluster-section cluster-actions">
        <button type="button" onclick="openAddNodePanel()" class="btn btn-primary">+ Node</button>
      </div>
    </div>
    <% } %>

    <% if (nodes.length === 0) { %>
      <% if (typeof tagFilter !== 'undefined' && tagFilter) { %>
      <%- include('partials/empty-state', {
        icon: '<svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>',
        title: 'Keine Nodes mit Tag "' + tagFilter + '"',
        text: 'Es gibt keine Nodes mit diesem Tag. Waehle einen anderen Tag oder zeige alle Nodes an.',
        buttonText: 'Alle Nodes anzeigen',
        buttonHref: '/'
      }) %>
      <% } else { %>
      <%- include('partials/empty-state', {
        icon: '<svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/><circle cx="12" cy="10" r="2"/></svg>',
        title: 'Keine Nodes vorhanden',
        text: 'Füge deine erste Maschine hinzu, um mit dem Monitoring zu starten.',
        buttonText: '+ Ersten Node hinzufügen',
        buttonOnclick: 'openAddNodePanel()'
      }) %>
      <% } %>
    <% } else { %>
      <% if (typeof tagFilter !== 'undefined' && tagFilter) { %>
      <!-- Active Tag Filter Banner -->
      <div class="active-filter-banner">
        <span class="active-filter-label">Gefiltert nach Tag:</span>
        <span class="active-filter-tag"><%= tagFilter %></span>
        <a href="/" class="active-filter-clear" title="Filter entfernen">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </a>
      </div>
      <% } %>
      <!-- Search/Filter Bar -->
      <div class="node-list-filter">
        <input
          type="text"
          id="nodeSearchInput"
          class="node-list-search"
          placeholder="Suche: cpu>80, ram<20, tags:prod, node:name..."
          title="Erweiterte Suche: cpu/ram/disk>80, vms>5, containers>10, tags:prod, node:name, status:online"
          onkeyup="debouncedFilter()">
        <div class="search-hint">
          <svg class="icon-info" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="16" x2="12" y2="12"></line>
            <line x1="12" y1="8" x2="12.01" y2="8"></line>
          </svg>
          <span>Erweiterte Suche: cpu>80, ram<20, disk>50, tags:prod, vms>5</span>
        </div>
        <select id="nodeTypeFilter" class="node-list-type-select" onchange="filterNodesAndCards()">
          <option value="">Alle Typen</option>
          <option value="proxmox-host">Proxmox</option>
          <option value="docker-host">Docker</option>
          <option value="raspberry-pi">Raspberry Pi</option>
          <option value="linux">Linux</option>
          <option value="windows">Windows</option>
        </select>
        <select id="nodeStatusFilter" class="node-list-status-select" onchange="filterNodesAndCards()">
          <option value="">Alle Status</option>
          <option value="online">Online</option>
          <option value="offline">Offline</option>
        </select>
        <div class="view-toggle-group">
          <button type="button" class="view-toggle active" id="btnListView" onclick="setViewMode('list')" title="Liste">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/>
              <line x1="3" y1="6" x2="3" y2="6"/><line x1="3" y1="12" x2="3" y2="12"/><line x1="3" y1="18" x2="3" y2="18"/>
            </svg>
          </button>
          <button type="button" class="view-toggle" id="btnCardsView" onclick="setViewMode('cards')" title="Karten">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/>
              <rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/>
            </svg>
          </button>
          <button type="button" class="view-toggle" id="btnTreeView" onclick="setViewMode('tree')" title="Baum">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 9l4-4l4 4"/><path d="M7 5v14"/><path d="M11 12h6"/><path d="M11 16h4"/>
            </svg>
          </button>
        </div>
        <div class="auto-refresh-control">
          <button type="button" class="btn btn-sm btn-icon" id="btnToggleRefresh" onclick="toggleAutoRefresh()" title="Auto-Refresh pausieren">
            <svg id="iconRefreshPause" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>
            </svg>
            <svg id="iconRefreshPlay" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none;">
              <polygon points="5 3 19 12 5 21 5 3"/>
            </svg>
          </button>
          <span class="refresh-countdown" id="refreshCountdown">30s</span>
        </div>
      </div>

      <%
      // Create stats lookup map
      var statsMap = {};
      if (typeof nodesWithStats !== 'undefined') {
        nodesWithStats.forEach(function(n) {
          statsMap[n.id] = n;
        });
      }

      // Render hierarchical list with indentation
      function renderNodeTree(nodeList, level) {
        nodeList.forEach(function(node) {
          var stats = statsMap[node.id] || {};
          var hasChildren = node.children && node.children.length > 0;
          var isParent = hasChildren;
      %>
          <div class="node-list-row<%= isParent ? ' parent-node' : '' %><%= level > 0 ? ' child-level-' + level : '' %>"
               data-node-id="<%= node.id %>"
               data-parent-id="<%= node.parent_id || '' %>"
               data-name="<%= node.name.toLowerCase() %>"
               data-type="<%= node.node_type || 'unknown' %>"
               data-status="<%= node.online ? 'online' : 'offline' %>"
               data-has-children="<%= hasChildren ? 'true' : 'false' %>">
            <div class="node-list-status">
              <span class="node-list-status-dot <%= node.online ? 'online' : 'offline' %>"></span>
            </div>
            <div class="node-list-icon">
              <% if (isParent) { %>
                <button class="tree-toggle" onclick="toggleChildren(<%= node.id %>); event.stopPropagation();" title="Expand/Collapse">
                  <svg class="icon-chevron" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="9 18 15 12 9 6"></polyline>
                  </svg>
                </button>
              <% } else { %>
                <span class="tree-spacer"></span>
              <% } %>
              <%- include('partials/node-type-icon', { nodeType: node.node_type || 'unknown', size: 22 }) %>
            </div>
            <div class="node-list-name">
              <a href="/nodes/<%= node.id %>"><%= node.name %></a>
              <% if (isParent && node.aggregate) { %>
                <span class="aggregate-stats">
                  (Total: <%= node.aggregate.total_cpu_cores %> cores,
                  <%= formatBytes(node.aggregate.total_ram_bytes) %>,
                  <%= node.aggregate.total_vms %> VMs,
                  <%= node.aggregate.total_nodes %> nodes)
                </span>
              <% } %>
              <span class="node-list-host-mobile"><%= node.host %></span>
            </div>
            <div class="node-list-host"><%= node.host %></div>
            <div class="node-list-uptime">
              <% if (node.online && stats.uptime_seconds) {
                var uptimeDays = Math.floor(stats.uptime_seconds / 86400);
                var uptimeHours = Math.floor((stats.uptime_seconds % 86400) / 3600);
                var uptimeMins = Math.floor((stats.uptime_seconds % 3600) / 60);
                var uptimeDisplay = uptimeDays > 0 ? (uptimeDays + 'd ' + uptimeHours + 'h') : (uptimeHours > 0 ? (uptimeHours + 'h ' + uptimeMins + 'm') : (uptimeMins + 'm'));
              %>
                <span class="uptime-value"><%= uptimeDisplay %></span>
              <% } else { %>
                <span class="uptime-na">-</span>
              <% } %>
            </div>
            <div class="node-list-metric pulse-metric">
              <% if (!node.online) { %>
                <span class="metric-na">-</span>
              <% } else { %>
                <%
                  var cpuClass = (stats.cpu_percent || 0) >= 95 ? 'critical' : (stats.cpu_percent || 0) >= 80 ? 'warning' : 'ok';
                %>
                <span class="metric-percent <%= cpuClass %>"><%= Math.round(stats.cpu_percent || 0) %>%</span>
                <% if (stats.cpu_cores) { %>
                  <span class="metric-detail">(<%= stats.cpu_cores %> cores)</span>
                <% } %>
              <% } %>
            </div>
            <div class="node-list-metric pulse-metric">
              <% if (!node.online) { %>
                <span class="metric-na">-</span>
              <% } else { %>
                <%
                  var ramClass = (stats.ram_percent || 0) >= 95 ? 'critical' : (stats.ram_percent || 0) >= 85 ? 'warning' : 'ok';
                  var ramUsed = stats.ram_used_bytes ? formatBytes(stats.ram_used_bytes) : '?';
                  var ramTotal = stats.ram_total_bytes ? formatBytes(stats.ram_total_bytes) : '?';
                %>
                <span class="metric-percent <%= ramClass %>"><%= Math.round(stats.ram_percent || 0) %>%</span>
                <% if (stats.ram_total_bytes) { %>
                  <span class="metric-detail">(<%= ramUsed %>/<%= ramTotal %>)</span>
                <% } %>
              <% } %>
            </div>
            <div class="node-list-metric pulse-metric">
              <% if (!node.online) { %>
                <span class="metric-na">-</span>
              <% } else { %>
                <%
                  var diskClass = (stats.disk_percent || 0) >= 95 ? 'critical' : (stats.disk_percent || 0) >= 80 ? 'warning' : 'ok';
                  var diskUsed = stats.disk_used_bytes ? formatBytes(stats.disk_used_bytes) : '?';
                  var diskTotal = stats.disk_total_bytes ? formatBytes(stats.disk_total_bytes) : '?';
                %>
                <span class="metric-percent <%= diskClass %>"><%= Math.round(stats.disk_percent || 0) %>%</span>
                <% if (stats.disk_total_bytes) { %>
                  <span class="metric-detail">(<%= diskUsed %>/<%= diskTotal %>)</span>
                <% } %>
              <% } %>
            </div>
            <div class="node-list-count">
              <%
                var vmCount = (stats.vms_running || 0) + (stats.cts_running || 0);
              %>
              <% if (vmCount > 0) { %>
                <span class="count-badge"><%= vmCount %></span>
              <% } else { %>
                <span class="count-na">-</span>
              <% } %>
            </div>
            <div class="node-list-count">
              <% if (stats.containers_running && stats.containers_running > 0) { %>
                <span class="count-badge"><%= stats.containers_running %></span>
              <% } else { %>
                <span class="count-na">-</span>
              <% } %>
            </div>
            <div class="node-list-type"><span class="node-type-badge <%= node.node_type || 'unknown' %>"><%= node.node_type || 'unknown' %></span></div>
            <div class="node-list-actions">
              <a href="/nodes/<%= node.id %>" class="node-list-action" title="Details">
                <span class="icon-arrow"></span>
              </a>
            </div>
          </div>
      <%
          if (node.children && node.children.length > 0) {
            renderNodeTree(node.children, level + 1);
          }
        });
      }
      %>

      <!-- Flat List View -->
      <div class="node-list" id="nodeListFlat">
        <div class="node-list-header">
          <div class="node-list-col-status"></div>
          <div class="node-list-col-icon"></div>
          <div class="node-list-col-name">Name</div>
          <div class="node-list-col-host">Host</div>
          <div class="node-list-col-uptime">Uptime</div>
          <div class="node-list-col-metrics">CPU</div>
          <div class="node-list-col-metrics">RAM</div>
          <div class="node-list-col-metrics">Disk</div>
          <div class="node-list-col-count">VMs</div>
          <div class="node-list-col-count">Container</div>
          <div class="node-list-col-type">Typ</div>
          <div class="node-list-col-actions"></div>
        </div>

        <% nodes.forEach(function(node) {
          var stats = statsMap[node.id] || {};
          var nodeStatus = node.online ? 'online' : 'offline';
          var cpuPercent = Math.round(stats.cpu_percent || 0);
          var memPercent = Math.round(stats.ram_percent || 0);
          var diskPercent = Math.round(stats.disk_percent || 0);
          var cpuClass = cpuPercent >= 80 ? 'critical' : (cpuPercent >= 60 ? 'warning' : '');
          var memClass = memPercent >= 80 ? 'critical' : (memPercent >= 60 ? 'warning' : '');
          var diskClass = diskPercent >= 80 ? 'critical' : (diskPercent >= 60 ? 'warning' : '');
          var vmCount = (stats.vms_running || 0) + (stats.cts_running || 0);
        %>
          <div class="node-list-row"
               data-node-id="<%= node.id %>"
               data-name="<%= node.name.toLowerCase() %>"
               data-type="<%= node.node_type || 'unknown' %>"
               data-status="<%= nodeStatus %>"
               data-cpu="<%= cpuPercent %>"
               data-ram="<%= memPercent %>"
               data-disk="<%= diskPercent %>"
               data-vms="<%= vmCount %>"
               data-containers="<%= stats.containers_running || 0 %>"
               data-uptime="<%= stats.uptime_seconds || 0 %>"
               data-tags="<%= node.tags || '' %>">
            <div class="node-list-status">
              <span class="node-list-status-dot <%= nodeStatus %>"></span>
            </div>
            <div class="node-list-icon">
              <%- include('partials/node-type-icon', { nodeType: node.node_type || 'unknown', size: 22 }) %>
            </div>
            <div class="node-list-name">
              <a href="/nodes/<%= node.id %>"><%= node.name %></a>
              <span class="node-list-host-mobile"><%= node.host %></span>
            </div>
            <div class="node-list-host"><%= node.host %></div>
            <div class="node-list-uptime">
              <% if (node.online && stats.uptime_seconds) {
                var uptimeDays = Math.floor(stats.uptime_seconds / 86400);
                var uptimeHours = Math.floor((stats.uptime_seconds % 86400) / 3600);
                var uptimeMins = Math.floor((stats.uptime_seconds % 3600) / 60);
                var uptimeDisplay = uptimeDays > 0 ? (uptimeDays + 'd ' + uptimeHours + 'h') : (uptimeHours > 0 ? (uptimeHours + 'h ' + uptimeMins + 'm') : (uptimeMins + 'm'));
              %>
                <span class="uptime-value"><%= uptimeDisplay %></span>
              <% } else { %>
                <span class="uptime-value offline">-</span>
              <% } %>
            </div>
            <div class="node-list-metric">
              <% if (node.online) { %>
                <div class="node-list-metric-bar">
                  <div class="node-list-metric-fill <%= cpuClass %>" style="width: <%= cpuPercent %>%;"></div>
                </div>
                <span class="node-list-metric-value <%= cpuClass %>"><%= cpuPercent %>%</span>
              <% } else { %>
                <span class="node-list-metric-value offline">-</span>
              <% } %>
            </div>
            <div class="node-list-metric">
              <% if (node.online) { %>
                <div class="node-list-metric-bar">
                  <div class="node-list-metric-fill <%= memClass %>" style="width: <%= memPercent %>%;"></div>
                </div>
                <span class="node-list-metric-value <%= memClass %>"><%= memPercent %>%</span>
              <% } else { %>
                <span class="node-list-metric-value offline">-</span>
              <% } %>
            </div>
            <div class="node-list-metric">
              <% if (node.online) { %>
                <div class="node-list-metric-bar">
                  <div class="node-list-metric-fill <%= diskClass %>" style="width: <%= diskPercent %>%;"></div>
                </div>
                <span class="node-list-metric-value <%= diskClass %>"><%= diskPercent %>%</span>
              <% } else { %>
                <span class="node-list-metric-value offline">-</span>
              <% } %>
            </div>
            <div class="node-list-count">
              <% if (vmCount > 0) { %>
                <span class="count-badge proxmox"><%= vmCount %></span>
              <% } else { %>
                <span class="count-badge empty">-</span>
              <% } %>
            </div>
            <div class="node-list-count">
              <% if (stats.containers_running && stats.containers_running > 0) { %>
                <span class="count-badge docker"><%= stats.containers_running %></span>
              <% } else { %>
                <span class="count-badge empty">-</span>
              <% } %>
            </div>
            <div class="node-list-type">
              <span class="type-tag <%= (node.node_type || 'unknown').toLowerCase() %>"><%= (node.node_type || 'Unknown').charAt(0).toUpperCase() + (node.node_type || 'Unknown').slice(1) %></span>
            </div>
            <div class="node-list-actions">
              <a href="/nodes/<%= node.id %>" class="node-list-action" title="Details">
                <span class="icon-arrow"></span>
              </a>
            </div>
          </div>
        <% }); %>
      </div>

      <!-- Tree View (Hierarchical) -->
      <div class="node-list tree-view" id="nodeListTree" style="display: none;">
        <div class="node-list-header">
          <div class="node-list-col-status"></div>
          <div class="node-list-col-icon"></div>
          <div class="node-list-col-name">Name</div>
          <div class="node-list-col-host">Host</div>
          <div class="node-list-col-uptime">Uptime</div>
          <div class="node-list-col-metrics">CPU</div>
          <div class="node-list-col-metrics">RAM</div>
          <div class="node-list-col-metrics">Disk</div>
          <div class="node-list-col-count">VMs</div>
          <div class="node-list-col-count">Containers</div>
          <div class="node-list-col-type">Typ</div>
          <div class="node-list-col-actions"></div>
        </div>

        <% if (typeof nodeTree !== 'undefined' && nodeTree.length > 0) {
          renderNodeTree(nodeTree, 0);
        } else {
          // Fallback: render flat list in tree view if no hierarchy
          nodes.forEach(function(node) {
            var stats = statsMap[node.id] || {};
        %>
          <div class="node-list-row"
               data-node-id="<%= node.id %>"
               data-name="<%= node.name.toLowerCase() %>"
               data-type="<%= node.node_type || 'unknown' %>"
               data-status="<%= node.online ? 'online' : 'offline' %>"
               data-cpu="<%= stats.cpu_percent || 0 %>"
               data-ram="<%= stats.ram_percent || 0 %>"
               data-disk="<%= stats.disk_percent || 0 %>"
               data-vms="<%= (stats.vms_running || 0) + (stats.cts_running || 0) %>"
               data-containers="<%= stats.containers_running || 0 %>"
               data-uptime="<%= stats.uptime_seconds || 0 %>"
               data-tags="<%= node.tags || '' %>">
            <div class="node-list-status">
              <span class="node-list-status-dot <%= node.online ? 'online' : 'offline' %>"></span>
            </div>
            <div class="node-list-icon">
              <%- include('partials/node-type-icon', { nodeType: node.node_type || 'unknown', size: 22 }) %>
            </div>
            <div class="node-list-name">
              <a href="/nodes/<%= node.id %>"><%= node.name %></a>
              <span class="node-list-host-mobile"><%= node.host %></span>
            </div>
            <div class="node-list-host"><%= node.host %></div>
            <div class="node-list-uptime">
              <% if (node.online && stats.uptime_seconds) {
                var uptimeDays = Math.floor(stats.uptime_seconds / 86400);
                var uptimeHours = Math.floor((stats.uptime_seconds % 86400) / 3600);
                var uptimeMins = Math.floor((stats.uptime_seconds % 3600) / 60);
                var uptimeDisplay = uptimeDays > 0 ? (uptimeDays + 'd ' + uptimeHours + 'h') : (uptimeHours > 0 ? (uptimeHours + 'h ' + uptimeMins + 'm') : (uptimeMins + 'm'));
              %>
                <span class="uptime-value"><%= uptimeDisplay %></span>
              <% } else { %>
                <span class="uptime-na">-</span>
              <% } %>
            </div>
            <div class="node-list-metric pulse-metric">
              <% if (!node.online) { %>
                <span class="metric-na">-</span>
              <% } else { %>
                <%
                  var cpuClass = (stats.cpu_percent || 0) >= 95 ? 'critical' : (stats.cpu_percent || 0) >= 80 ? 'warning' : 'ok';
                %>
                <span class="metric-percent <%= cpuClass %>"><%= Math.round(stats.cpu_percent || 0) %>%</span>
                <% if (stats.cpu_cores) { %>
                  <span class="metric-detail">(<%= stats.cpu_cores %> cores)</span>
                <% } %>
              <% } %>
            </div>
            <div class="node-list-metric pulse-metric">
              <% if (!node.online) { %>
                <span class="metric-na">-</span>
              <% } else { %>
                <%
                  var ramClass = (stats.ram_percent || 0) >= 95 ? 'critical' : (stats.ram_percent || 0) >= 85 ? 'warning' : 'ok';
                  var ramUsed = stats.ram_used_bytes ? formatBytes(stats.ram_used_bytes) : '?';
                  var ramTotal = stats.ram_total_bytes ? formatBytes(stats.ram_total_bytes) : '?';
                %>
                <span class="metric-percent <%= ramClass %>"><%= Math.round(stats.ram_percent || 0) %>%</span>
                <% if (stats.ram_total_bytes) { %>
                  <span class="metric-detail">(<%= ramUsed %>/<%= ramTotal %>)</span>
                <% } %>
              <% } %>
            </div>
            <div class="node-list-metric pulse-metric">
              <% if (!node.online) { %>
                <span class="metric-na">-</span>
              <% } else { %>
                <%
                  var diskClass = (stats.disk_percent || 0) >= 95 ? 'critical' : (stats.disk_percent || 0) >= 80 ? 'warning' : 'ok';
                  var diskUsed = stats.disk_used_bytes ? formatBytes(stats.disk_used_bytes) : '?';
                  var diskTotal = stats.disk_total_bytes ? formatBytes(stats.disk_total_bytes) : '?';
                %>
                <span class="metric-percent <%= diskClass %>"><%= Math.round(stats.disk_percent || 0) %>%</span>
                <% if (stats.disk_total_bytes) { %>
                  <span class="metric-detail">(<%= diskUsed %>/<%= diskTotal %>)</span>
                <% } %>
              <% } %>
            </div>
            <div class="node-list-count">
              <%
                var vmCount = (stats.vms_running || 0) + (stats.cts_running || 0);
              %>
              <% if (vmCount > 0) { %>
                <span class="count-badge"><%= vmCount %></span>
              <% } else { %>
                <span class="count-na">-</span>
              <% } %>
            </div>
            <div class="node-list-count">
              <% if (stats.containers_running && stats.containers_running > 0) { %>
                <span class="count-badge"><%= stats.containers_running %></span>
              <% } else { %>
                <span class="count-na">-</span>
              <% } %>
            </div>
            <div class="node-list-type"><span class="node-type-badge <%= node.node_type || 'unknown' %>"><%= node.node_type || 'unknown' %></span></div>
            <div class="node-list-actions">
              <a href="/nodes/<%= node.id %>" class="node-list-action" title="Details">
                <span class="icon-arrow"></span>
              </a>
            </div>
          </div>
        <%
          });
        } %>
      </div>

      <!-- Cards View (Monitoring-Style) -->
      <div class="node-cards-view" id="nodeCardsView" style="display: none;">
        <% if (typeof nodesWithStats !== 'undefined' && nodesWithStats.length > 0) { %>
          <div class="monitoring-grid">
            <% nodesWithStats.forEach(function(node) {
              // Determine status class
              var statusClass = 'offline';
              if (node.online) {
                var maxPercent = Math.max(node.cpu_percent || 0, node.ram_percent || 0, node.disk_percent || 0);
                if (maxPercent >= thresholds.cpu_critical || maxPercent >= thresholds.ram_critical || maxPercent >= thresholds.disk_critical) {
                  statusClass = 'critical';
                } else if (maxPercent >= thresholds.cpu_warning || maxPercent >= thresholds.ram_warning || maxPercent >= thresholds.disk_warning) {
                  statusClass = 'warning';
                } else {
                  statusClass = 'ok';
                }
              }
            %>
            <div class="monitoring-card <%= statusClass %>"
                 data-node-id="<%= node.id %>"
                 data-name="<%= node.name.toLowerCase() %>"
                 data-type="<%= node.node_type || 'unknown' %>"
                 data-status="<%= node.online ? 'online' : 'offline' %>">
              <div class="monitoring-header">
                <div class="monitoring-header-left">
                  <a href="/nodes/<%= node.id %>" class="monitoring-name"><%= node.name %></a>
                  <span class="monitoring-type"><%= node.node_type || 'unknown' %></span>
                </div>
                <span class="monitoring-status <%= node.online ? 'online' : 'offline' %>">
                  <%= node.online ? 'Online' : 'Offline' %>
                </span>
              </div>

              <% if (node.online && (node.cpu_percent !== null || node.ram_percent !== null)) { %>
              <div class="monitoring-stats">
                <!-- CPU -->
                <div class="stat-bar">
                  <div class="stat-bar-label">
                    <span>CPU</span>
                    <span class="stat-bar-value <%= (node.cpu_percent || 0) >= thresholds.cpu_critical ? 'critical' : ((node.cpu_percent || 0) >= thresholds.cpu_warning ? 'warning' : '') %>">
                      <%= node.cpu_percent !== null ? Math.round(node.cpu_percent) + '%' : '-' %>
                    </span>
                  </div>
                  <div class="stat-bar-track">
                    <div class="stat-bar-fill <%= (node.cpu_percent || 0) >= thresholds.cpu_critical ? 'critical' : ((node.cpu_percent || 0) >= thresholds.cpu_warning ? 'warning' : 'ok') %>"
                         style="width: <%= Math.min(node.cpu_percent || 0, 100) %>%"></div>
                  </div>
                  <% if (node.cpu_cores) { %>
                  <div class="stat-bar-detail"><%= node.cpu_cores %> cores</div>
                  <% } %>
                </div>

                <!-- RAM -->
                <div class="stat-bar">
                  <div class="stat-bar-label">
                    <span>RAM</span>
                    <span class="stat-bar-value <%= (node.ram_percent || 0) >= thresholds.ram_critical ? 'critical' : ((node.ram_percent || 0) >= thresholds.ram_warning ? 'warning' : '') %>">
                      <%= node.ram_percent !== null ? Math.round(node.ram_percent) + '%' : '-' %>
                    </span>
                  </div>
                  <div class="stat-bar-track">
                    <div class="stat-bar-fill <%= (node.ram_percent || 0) >= thresholds.ram_critical ? 'critical' : ((node.ram_percent || 0) >= thresholds.ram_warning ? 'warning' : 'ok') %>"
                         style="width: <%= Math.min(node.ram_percent || 0, 100) %>%"></div>
                  </div>
                  <% if (node.ram_total_bytes) { %>
                  <div class="stat-bar-detail"><%= formatBytes(node.ram_used_bytes || 0) %> / <%= formatBytes(node.ram_total_bytes) %></div>
                  <% } %>
                </div>

                <!-- Disk -->
                <div class="stat-bar">
                  <div class="stat-bar-label">
                    <span>Disk</span>
                    <span class="stat-bar-value <%= (node.disk_percent || 0) >= thresholds.disk_critical ? 'critical' : ((node.disk_percent || 0) >= thresholds.disk_warning ? 'warning' : '') %>">
                      <%= node.disk_percent !== null ? Math.round(node.disk_percent) + '%' : '-' %>
                    </span>
                  </div>
                  <div class="stat-bar-track">
                    <div class="stat-bar-fill <%= (node.disk_percent || 0) >= thresholds.disk_critical ? 'critical' : ((node.disk_percent || 0) >= thresholds.disk_warning ? 'warning' : 'ok') %>"
                         style="width: <%= Math.min(node.disk_percent || 0, 100) %>%"></div>
                  </div>
                  <% if (node.disk_total_bytes) { %>
                  <div class="stat-bar-detail"><%= formatBytes(node.disk_used_bytes || 0) %> / <%= formatBytes(node.disk_total_bytes) %></div>
                  <% } %>
                </div>

                <% if (node.temp_cpu !== null) { %>
                <!-- Temperature -->
                <div class="stat-bar">
                  <div class="stat-bar-label">
                    <span>Temp</span>
                    <span class="stat-bar-value <%= (node.temp_cpu || 0) >= thresholds.temp_critical ? 'critical' : ((node.temp_cpu || 0) >= thresholds.temp_warning ? 'warning' : '') %>">
                      <%= Math.round(node.temp_cpu) %>&deg;C
                    </span>
                  </div>
                </div>
                <% } %>
              </div>

              <div class="monitoring-meta">
                <% if (node.load_1m !== null) { %>
                <span>Load: <%= node.load_1m %></span>
                <% } %>
                <% if (node.uptime_seconds) { %>
                <%
                  var cardUptimeDays = Math.floor(node.uptime_seconds / 86400);
                  var cardUptimeHours = Math.floor((node.uptime_seconds % 86400) / 3600);
                  var cardUptimeDisplay = cardUptimeDays > 0 ? (cardUptimeDays + 'd ' + cardUptimeHours + 'h') : (cardUptimeHours + 'h');
                %>
                <span>Up: <%= cardUptimeDisplay %></span>
                <% } %>
                <%
                  var cardVmCount = (node.vms_running || 0) + (node.cts_running || 0);
                %>
                <% if (cardVmCount > 0) { %>
                <span>VMs: <%= cardVmCount %></span>
                <% } %>
                <% if (node.containers_running > 0) { %>
                <span>Containers: <%= node.containers_running %></span>
                <% } %>
              </div>
              <% } else { %>
              <div class="monitoring-stats monitoring-stats-offline">
                <p class="monitoring-no-data">Keine Daten verfügbar</p>
              </div>
              <% } %>
            </div>
            <% }); %>
          </div>
        <% } else { %>
          <%- include('partials/empty-state', {
            title: 'Keine Monitoring-Daten verfügbar.'
          }) %>
        <% } %>
      </div>

      <!-- Filter Results Counter -->
      <div class="node-list-counter" id="nodeListCounter">
        <span id="visibleCount"><%= nodes.length %></span> / <%= nodes.length %> Nodes
      </div>

<script>
// Thresholds für Client-seitige Logik verfügbar machen
var thresholds = {
  cpu_warning: <%= thresholds.cpu_warning %>,
  cpu_critical: <%= thresholds.cpu_critical %>,
  ram_warning: <%= thresholds.ram_warning %>,
  ram_critical: <%= thresholds.ram_critical %>,
  disk_warning: <%= thresholds.disk_warning %>,
  disk_critical: <%= thresholds.disk_critical %>,
  temp_warning: <%= thresholds.temp_warning %>,
  temp_critical: <%= thresholds.temp_critical %>
};

// Dashboard-Refresh-Interval aus Settings (in Sekunden)
var dashboardRefreshInterval = <%= dashboardRefreshInterval %>;

// Debounce Helper (ES5-kompatibel)
var debounceTimers = {};
function debounce(func, delay, key) {
  return function() {
    var context = this;
    var args = arguments;
    clearTimeout(debounceTimers[key]);
    debounceTimers[key] = setTimeout(function() {
      func.apply(context, args);
    }, delay);
  };
}

// ES5 Node Filter Function with Advanced Search
function filterNodes() {
  var searchInput = document.getElementById('nodeSearchInput');
  var typeFilter = document.getElementById('nodeTypeFilter');
  var statusFilter = document.getElementById('nodeStatusFilter');
  var rows = document.querySelectorAll('.node-list-row, .node-row-pulse');
  var visibleCount = 0;

  var searchQuery = searchInput ? searchInput.value : '';
  var typeValue = typeFilter ? typeFilter.value : '';
  var statusValue = statusFilter ? statusFilter.value : '';

  // Parse advanced search query
  var parsedQuery = null;
  if (searchQuery && typeof parseSearchQuery === 'function') {
    parsedQuery = parseSearchQuery(searchQuery);
  }

  for (var i = 0; i < rows.length; i++) {
    var row = rows[i];
    var nodeId = row.getAttribute('data-node-id');
    var type = row.getAttribute('data-type') || '';
    var status = row.getAttribute('data-status') || '';

    var matchesSearch = true;
    var matchesType = !typeValue || type === typeValue;
    var matchesStatus = !statusValue || status === statusValue;

    // Advanced search with parser
    if (parsedQuery) {
      // Build node object from data attributes and stats
      var hostEl = row.querySelector('.node-list-host') || row.querySelector('.node-host');
      var nodeData = {
        id: nodeId,
        name: row.getAttribute('data-name') || '',
        host: hostEl ? hostEl.textContent : '',
        node_type: type,
        online: status === 'online',
        cpu_percent: parseFloat(row.getAttribute('data-cpu')) || 0,
        ram_percent: parseFloat(row.getAttribute('data-ram')) || 0,
        disk_percent: parseFloat(row.getAttribute('data-disk')) || 0,
        vms_running: parseInt(row.getAttribute('data-vms')) || 0,
        cts_running: 0,
        containers_running: parseInt(row.getAttribute('data-containers')) || 0,
        uptime_seconds: parseInt(row.getAttribute('data-uptime')) || 0,
        tags: row.getAttribute('data-tags') || ''
      };

      matchesSearch = matchNode(nodeData, parsedQuery);
    } else if (searchQuery) {
      // Fallback: Simple text search
      var name = row.getAttribute('data-name') || '';
      matchesSearch = name.indexOf(searchQuery.toLowerCase()) > -1;
    }

    if (matchesSearch && matchesType && matchesStatus) {
      row.style.display = '';
      visibleCount++;
    } else {
      row.style.display = 'none';
    }
  }

  var counterEl = document.getElementById('visibleCount');
  if (counterEl) {
    counterEl.textContent = visibleCount;
  }
}

// View Mode Toggle (List vs Cards vs Tree)
var currentViewMode = 'list';

function setViewMode(mode) {
  currentViewMode = mode;
  var nodeListFlat = document.getElementById('nodeListFlat');
  var nodeListTree = document.getElementById('nodeListTree');
  var nodeCardsView = document.getElementById('nodeCardsView');
  var nodeListCounter = document.getElementById('nodeListCounter');
  var btnList = document.getElementById('btnListView');
  var btnCards = document.getElementById('btnCardsView');
  var btnTree = document.getElementById('btnTreeView');

  // Reset all buttons
  if (btnList) btnList.classList.remove('active');
  if (btnCards) btnCards.classList.remove('active');
  if (btnTree) btnTree.classList.remove('active');

  // Hide all views
  if (nodeListFlat) nodeListFlat.style.display = 'none';
  if (nodeListTree) nodeListTree.style.display = 'none';
  if (nodeCardsView) nodeCardsView.style.display = 'none';
  if (nodeListCounter) nodeListCounter.style.display = 'none';

  if (mode === 'cards') {
    if (nodeCardsView) nodeCardsView.style.display = 'block';
    if (btnCards) btnCards.classList.add('active');
  } else if (mode === 'tree') {
    if (nodeListTree) nodeListTree.style.display = 'block';
    if (nodeListCounter) nodeListCounter.style.display = 'block';
    if (btnTree) btnTree.classList.add('active');
  } else {
    // Default: list (flat)
    if (nodeListFlat) nodeListFlat.style.display = 'block';
    if (nodeListCounter) nodeListCounter.style.display = 'block';
    if (btnList) btnList.classList.add('active');
  }

  // Save preference
  try { localStorage.setItem('dashboard-view-mode', mode); } catch (e) {}
}

// Filter also works on cards
function filterNodesAndCards() {
  filterNodes();

  // Also filter cards view
  var searchInput = document.getElementById('nodeSearchInput');
  var typeFilter = document.getElementById('nodeTypeFilter');
  var statusFilter = document.getElementById('nodeStatusFilter');
  var cards = document.querySelectorAll('.monitoring-card');

  var searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
  var typeValue = typeFilter ? typeFilter.value : '';
  var statusValue = statusFilter ? statusFilter.value : '';

  for (var i = 0; i < cards.length; i++) {
    var card = cards[i];
    var name = card.getAttribute('data-name') || '';
    var type = card.getAttribute('data-type') || '';
    var status = card.getAttribute('data-status') || '';

    var matchesSearch = name.indexOf(searchTerm) > -1;
    var matchesType = !typeValue || type === typeValue;
    var matchesStatus = !statusValue || status === statusValue;

    if (matchesSearch && matchesType && matchesStatus) {
      card.style.display = '';
    } else {
      card.style.display = 'none';
    }
  }
}

// Debounced Filter-Funktion (300ms Verzögerung)
var debouncedFilter = debounce(filterNodesAndCards, 300, 'nodeFilter');

// Restore view mode on load (check URL param first, then localStorage)
(function() {
  try {
    // Check URL parameter (e.g., ?view=cards from /monitoring redirect)
    var urlParams = window.location.search;
    var viewMatch = urlParams.match(/[?&]view=([^&]+)/);
    if (viewMatch && (viewMatch[1] === 'cards' || viewMatch[1] === 'tree' || viewMatch[1] === 'list')) {
      setViewMode(viewMatch[1]);
      // Clean up URL without reload
      if (window.history && window.history.replaceState) {
        var cleanUrl = window.location.pathname + urlParams.replace(/[?&]view=[^&]+/, '').replace(/^\?$/, '');
        window.history.replaceState({}, document.title, cleanUrl || window.location.pathname);
      }
      return;
    }
    // Fallback to localStorage
    var savedMode = localStorage.getItem('dashboard-view-mode');
    if (savedMode === 'cards' || savedMode === 'tree') {
      setViewMode(savedMode);
    }
  } catch (e) {}
})();

// Auto-Refresh (ES5)
var autoRefreshInterval = null;
var autoRefreshCountdown = dashboardRefreshInterval;
var autoRefreshPaused = false;
var countdownInterval = null;

function updateCountdownDisplay() {
  var el = document.getElementById('refreshCountdown');
  if (el) {
    el.textContent = autoRefreshCountdown + 's';
  }
}

function startAutoRefresh() {
  autoRefreshPaused = false;
  autoRefreshCountdown = dashboardRefreshInterval;
  updateCountdownDisplay();

  // Update icons
  var pauseIcon = document.getElementById('iconRefreshPause');
  var playIcon = document.getElementById('iconRefreshPlay');
  var btn = document.getElementById('btnToggleRefresh');
  if (pauseIcon) pauseIcon.style.display = '';
  if (playIcon) playIcon.style.display = 'none';
  if (btn) btn.title = 'Auto-Refresh pausieren';

  // Clear existing intervals
  if (countdownInterval) clearInterval(countdownInterval);
  if (autoRefreshInterval) clearInterval(autoRefreshInterval);

  // Countdown every second
  countdownInterval = setInterval(function() {
    if (!autoRefreshPaused) {
      autoRefreshCountdown--;
      updateCountdownDisplay();
      if (autoRefreshCountdown <= 0) {
        refreshDashboardData();
      }
    }
  }, 1000);
}

function pauseAutoRefresh() {
  autoRefreshPaused = true;

  // Update icons
  var pauseIcon = document.getElementById('iconRefreshPause');
  var playIcon = document.getElementById('iconRefreshPlay');
  var btn = document.getElementById('btnToggleRefresh');
  var countdownEl = document.getElementById('refreshCountdown');
  if (pauseIcon) pauseIcon.style.display = 'none';
  if (playIcon) playIcon.style.display = '';
  if (btn) btn.title = 'Auto-Refresh fortsetzen';
  if (countdownEl) countdownEl.textContent = 'Pausiert';
}

function toggleAutoRefresh() {
  if (autoRefreshPaused) {
    startAutoRefresh();
  } else {
    pauseAutoRefresh();
  }
  // Save preference
  try { localStorage.setItem('dashboard-autorefresh-paused', autoRefreshPaused ? '1' : '0'); } catch (e) {}
}

// ==========================================
// API-basierter Refresh (statt Page Reload)
// ==========================================

// Helper: CSS-Klassen für Progress-Bars
function getBarClass(value, warningThreshold, criticalThreshold) {
  if (value >= criticalThreshold) return 'critical';
  if (value >= warningThreshold) return 'warning';
  return 'ok';
}

// Helper: CSS-Klassen für Werte
function getValueClass(value, warningThreshold, criticalThreshold) {
  if (value >= criticalThreshold) return 'critical';
  if (value >= warningThreshold) return 'warning';
  return '';
}

// Helper: Alert-Level bestimmen
function getAlertLevel(node) {
  if (!node.online) return 'offline';
  var maxCpu = node.cpu_percent >= thresholds.cpu_critical;
  var maxRam = node.ram_percent >= thresholds.ram_critical;
  var maxDisk = node.disk_percent >= thresholds.disk_critical;
  if (maxCpu || maxRam || maxDisk) return 'critical';

  var warnCpu = node.cpu_percent >= thresholds.cpu_warning;
  var warnRam = node.ram_percent >= thresholds.ram_warning;
  var warnDisk = node.disk_percent >= thresholds.disk_warning;
  if (warnCpu || warnRam || warnDisk) return 'warning';

  return 'ok';
}

// API-Aufruf für Dashboard-Refresh (mit TOON-Support)
function refreshDashboardData() {
  // Check if TOON format is enabled
  var useTOON = false;
  try {
    useTOON = localStorage.getItem('nodepulse-use-toon') === 'true';
  } catch (e) {}

  var apiUrl = '/api/stats';

  // Add format=toon if enabled
  if (useTOON) {
    apiUrl += '?format=toon';

    // Include metadata hash if we have cached metadata
    if (window.NP && window.NP.SafeStorage) {
      try {
        var cached = window.NP.SafeStorage.getItem('toon-metadata');
        if (cached && cached.hash) {
          apiUrl += '&metadata_hash=' + cached.hash;
        }
      } catch (e) {}
    }
  }

  var xhr = new XMLHttpRequest();
  xhr.open('GET', apiUrl, true);
  xhr.timeout = 30000;

  xhr.onreadystatechange = function() {
    if (xhr.readyState === 4) {
      if (xhr.status === 200) {
        var response = JSON.parse(xhr.responseText);
        if (response.success) {
          // TOON format is auto-parsed by main.js
          updateDashboard(response.data);
        }
      }
      // Countdown zurücksetzen
      autoRefreshCountdown = dashboardRefreshInterval;
    }
  };

  xhr.send();
}

// Update Stats-Cards (Total, Online, Offline)
function updateStatsCards(nodes) {
  var total = nodes.length;
  var online = 0;
  for (var i = 0; i < nodes.length; i++) {
    if (nodes[i].online) online++;
  }
  var offline = total - online;

  // Update DOM
  var totalEl = document.querySelector('.stats-card-value');
  var onlineEl = document.querySelector('.stats-card-online .stats-card-value');
  var offlineEl = document.querySelector('.stats-card-offline .stats-card-value');

  if (totalEl) totalEl.textContent = total;
  if (onlineEl) onlineEl.textContent = online;
  if (offlineEl) offlineEl.textContent = offline;
}

// Update List-View (Mini-Bars and Compact Bars)
function updateListView(nodes) {
  for (var i = 0; i < nodes.length; i++) {
    var node = nodes[i];
    var row = document.querySelector('.node-list-row[data-node-id="' + node.id + '"]') ||
              document.querySelector('.node-row-pulse[data-node-id="' + node.id + '"]');
    if (!row) continue;

    // Update status class for pulse rows
    if (row.classList.contains('node-row-pulse')) {
      row.className = 'node-row-pulse ' + (node.online ? 'online' : 'offline');
      var statusDot = row.querySelector('.node-tree-status');
      if (statusDot) {
        statusDot.className = 'node-tree-status ' + (node.online ? 'online' : 'offline');
      }

      // Update metric bars (CPU, RAM)
      var compactBars = row.querySelectorAll('.metric-bar-compact');
      if (compactBars.length >= 2 && node.online) {
        var cpuPercent = Math.round(node.cpu_percent || 0);
        var ramPercent = Math.round(node.ram_percent || 0);

        // CPU Bar
        var cpuFill = compactBars[0].querySelector('.fill');
        var cpuValue = compactBars[0].querySelector('.value');
        if (cpuFill && cpuValue) {
          cpuFill.className = 'fill ' + getBarClass(cpuPercent, thresholds.cpu_warning, thresholds.cpu_critical);
          cpuFill.style.width = Math.min(cpuPercent, 100) + '%';
          cpuValue.textContent = cpuPercent + '%';
        }

        // RAM Bar
        var ramFill = compactBars[1].querySelector('.fill');
        var ramValue = compactBars[1].querySelector('.value');
        if (ramFill && ramValue) {
          ramFill.className = 'fill ' + getBarClass(ramPercent, thresholds.ram_warning, thresholds.ram_critical);
          ramFill.style.width = Math.min(ramPercent, 100) + '%';
          ramValue.textContent = ramPercent + '%';
        }
      }
    } else {
      // Legacy node-list-row support
      var statusDot = row.querySelector('.node-list-status-dot');
      if (statusDot) {
        statusDot.className = 'node-list-status-dot ' + (node.online ? 'online' : 'offline');
      }

      // Mini-Bars (CPU, RAM, Disk)
      var metrics = row.querySelectorAll('.node-list-metric');

      // CPU (index 0)
      if (metrics[0] && node.online) {
        var cpuPercent = Math.round(node.cpu_percent || 0);
        var cpuBar = metrics[0].querySelector('.mini-bar-fill');
        var cpuValue = metrics[0].querySelector('.mini-bar-value');
        if (cpuBar) {
          cpuBar.className = 'mini-bar-fill ' + getBarClass(cpuPercent, thresholds.cpu_warning, thresholds.cpu_critical);
          cpuBar.style.width = Math.min(cpuPercent, 100) + '%';
        }
        if (cpuValue) cpuValue.textContent = cpuPercent + '%';
      }

      // RAM (index 1)
      if (metrics[1] && node.online) {
        var ramPercent = Math.round(node.ram_percent || 0);
        var ramBar = metrics[1].querySelector('.mini-bar-fill');
        var ramValue = metrics[1].querySelector('.mini-bar-value');
        if (ramBar) {
          ramBar.className = 'mini-bar-fill ' + getBarClass(ramPercent, thresholds.ram_warning, thresholds.ram_critical);
          ramBar.style.width = Math.min(ramPercent, 100) + '%';
        }
        if (ramValue) ramValue.textContent = ramPercent + '%';
      }

      // Disk (index 2)
      if (metrics[2] && node.online) {
        var diskPercent = Math.round(node.disk_percent || 0);
        var diskBar = metrics[2].querySelector('.mini-bar-fill');
        var diskValue = metrics[2].querySelector('.mini-bar-value');
        if (diskBar) {
          diskBar.className = 'mini-bar-fill ' + getBarClass(diskPercent, thresholds.disk_warning, thresholds.disk_critical);
          diskBar.style.width = Math.min(diskPercent, 100) + '%';
        }
        if (diskValue) diskValue.textContent = diskPercent + '%';
      }
    }
  }
}

// Update Cards-View (Monitoring-Style)
function updateCardsView(nodes) {
  for (var i = 0; i < nodes.length; i++) {
    var node = nodes[i];
    var card = document.querySelector('.monitoring-card[data-node-id="' + node.id + '"]');
    if (!card) continue;

    // Status-Klasse
    var alertLevel = getAlertLevel(node);
    card.className = 'monitoring-card ' + alertLevel +
                     (card.getAttribute('data-name') ? ' ' : '') +
                     (card.getAttribute('data-type') ? ' ' : '') +
                     (card.getAttribute('data-status') ? ' ' : '');
    card.setAttribute('data-status', node.online ? 'online' : 'offline');

    // Status-Badge
    var statusBadge = card.querySelector('.monitoring-status');
    if (statusBadge) {
      statusBadge.className = 'monitoring-status ' + (node.online ? 'online' : 'offline');
      statusBadge.textContent = node.online ? 'Online' : 'Offline';
    }

    if (!node.online) continue;

    // Stat-Bars (CPU, RAM, Disk, Temp)
    var statBars = card.querySelectorAll('.stat-bar');

    // CPU (index 0)
    if (statBars[0]) {
      var cpuPercent = Math.round(node.cpu_percent || 0);
      var cpuValueEl = statBars[0].querySelector('.stat-bar-value');
      var cpuFill = statBars[0].querySelector('.stat-bar-fill');

      if (cpuValueEl) {
        cpuValueEl.className = 'stat-bar-value ' + getValueClass(cpuPercent, thresholds.cpu_warning, thresholds.cpu_critical);
        cpuValueEl.textContent = cpuPercent + '%';
      }
      if (cpuFill) {
        cpuFill.className = 'stat-bar-fill ' + getBarClass(cpuPercent, thresholds.cpu_warning, thresholds.cpu_critical);
        cpuFill.style.width = Math.min(cpuPercent, 100) + '%';
      }
    }

    // RAM (index 1)
    if (statBars[1]) {
      var ramPercent = Math.round(node.ram_percent || 0);
      var ramValueEl = statBars[1].querySelector('.stat-bar-value');
      var ramFill = statBars[1].querySelector('.stat-bar-fill');

      if (ramValueEl) {
        ramValueEl.className = 'stat-bar-value ' + getValueClass(ramPercent, thresholds.ram_warning, thresholds.ram_critical);
        ramValueEl.textContent = ramPercent + '%';
      }
      if (ramFill) {
        ramFill.className = 'stat-bar-fill ' + getBarClass(ramPercent, thresholds.ram_warning, thresholds.ram_critical);
        ramFill.style.width = Math.min(ramPercent, 100) + '%';
      }
    }

    // Disk (index 2)
    if (statBars[2]) {
      var diskPercent = Math.round(node.disk_percent || 0);
      var diskValueEl = statBars[2].querySelector('.stat-bar-value');
      var diskFill = statBars[2].querySelector('.stat-bar-fill');

      if (diskValueEl) {
        diskValueEl.className = 'stat-bar-value ' + getValueClass(diskPercent, thresholds.disk_warning, thresholds.disk_critical);
        diskValueEl.textContent = diskPercent + '%';
      }
      if (diskFill) {
        diskFill.className = 'stat-bar-fill ' + getBarClass(diskPercent, thresholds.disk_warning, thresholds.disk_critical);
        diskFill.style.width = Math.min(diskPercent, 100) + '%';
      }
    }

    // Temp (index 3)
    if (statBars[3] && node.temp_cpu !== null) {
      var tempValueEl = statBars[3].querySelector('.stat-bar-value');
      var tempValue = Math.round(node.temp_cpu);

      if (tempValueEl) {
        tempValueEl.className = 'stat-bar-value ' + getValueClass(tempValue, thresholds.temp_warning, thresholds.temp_critical);
        tempValueEl.innerHTML = tempValue + '&deg;C';
      }
    }

    // Meta-Info (Load, Uptime)
    var metaEl = card.querySelector('.monitoring-meta');
    if (metaEl && node.load_1m !== null) {
      var metaHtml = '<span>Load: ' + node.load_1m + '</span>';
      if (node.uptime_seconds) {
        metaHtml += '<span>Up: ' + Math.floor(node.uptime_seconds / 86400) + 'd</span>';
      }
      metaEl.innerHTML = metaHtml;
    }
  }
}

// Master Update-Funktion
function updateDashboard(nodes) {
  updateStatsCards(nodes);
  updateListView(nodes);
  updateCardsView(nodes);
}

// Toggle Parent-Child Nodes (Grouped View)
function toggleChildren(parentId) {
  var allRows = document.querySelectorAll('.node-list-row');
  var parentRow = null;

  // Find parent row
  for (var i = 0; i < allRows.length; i++) {
    if (allRows[i].getAttribute('data-node-id') == parentId) {
      parentRow = allRows[i];
      break;
    }
  }

  if (!parentRow) return;

  var chevron = parentRow.querySelector('.icon-chevron');
  var isExpanded = parentRow.classList.contains('expanded');

  // Toggle child rows
  for (var i = 0; i < allRows.length; i++) {
    var row = allRows[i];
    var rowParentId = row.getAttribute('data-parent-id');

    if (rowParentId == parentId) {
      if (isExpanded) {
        row.style.display = 'none';
      } else {
        row.style.display = '';
      }
    }
  }

  // Toggle chevron and class
  if (isExpanded) {
    parentRow.classList.remove('expanded');
    if (chevron) chevron.style.transform = 'rotate(0deg)';
  } else {
    parentRow.classList.add('expanded');
    if (chevron) chevron.style.transform = 'rotate(90deg)';
  }

  // Save state
  try {
    localStorage.setItem('node-' + parentId + '-expanded', !isExpanded ? '1' : '0');
  } catch (e) {}
}

// Init Grouped View expand/collapse state
function initGroupedViewState() {
  var parentRows = document.querySelectorAll('.node-list-row[data-has-children="true"]');

  for (var i = 0; i < parentRows.length; i++) {
    var row = parentRows[i];
    var nodeId = row.getAttribute('data-node-id');

    // Check saved state
    var savedState = '1'; // Default: expanded
    try {
      savedState = localStorage.getItem('node-' + nodeId + '-expanded') || '1';
    } catch (e) {}

    if (savedState === '0') {
      // Should be collapsed
      toggleChildren(nodeId);
    } else {
      // Should be expanded (default)
      row.classList.add('expanded');
      var chevron = row.querySelector('.icon-chevron');
      if (chevron) chevron.style.transform = 'rotate(90deg)';
    }
  }
}

// Init auto-refresh
(function() {
  try {
    var savedPaused = localStorage.getItem('dashboard-autorefresh-paused');
    if (savedPaused === '1') {
      pauseAutoRefresh();
    } else {
      startAutoRefresh();
    }
  } catch (e) {
    startAutoRefresh();
  }

  // Init grouped view state
  initGroupedViewState();
})();
</script>
    <% } %>
  </main>
</div>

<%- include('partials/footer') %>

<!-- Cluster Sparklines -->
<script>
(function initClusterSparklines() {
  // Wait for Sparkline class to be available
  if (typeof Sparkline === 'undefined') {
    setTimeout(initClusterSparklines, 100);
    return;
  }

  var cpuCanvas = document.getElementById('cluster-sparkline-cpu');
  var ramCanvas = document.getElementById('cluster-sparkline-ram');
  var diskCanvas = document.getElementById('cluster-sparkline-disk');

  if (!cpuCanvas && !ramCanvas && !diskCanvas) return;

  var baseOptions = {
    lineWidth: 1.5,
    pointRadius: 0,
    showArea: true,
    padding: { top: 2, right: 2, bottom: 2, left: 2 },
    animate: false
  };

  var sparklineCpu = cpuCanvas ? new Sparkline(cpuCanvas, [], {
    lineWidth: baseOptions.lineWidth,
    pointRadius: baseOptions.pointRadius,
    showArea: baseOptions.showArea,
    padding: baseOptions.padding,
    animate: baseOptions.animate,
    lineColor: '#5fa332',
    fillColor: 'rgba(95, 163, 50, 0.3)'
  }) : null;

  var sparklineRam = ramCanvas ? new Sparkline(ramCanvas, [], {
    lineWidth: baseOptions.lineWidth,
    pointRadius: baseOptions.pointRadius,
    showArea: baseOptions.showArea,
    padding: baseOptions.padding,
    animate: baseOptions.animate,
    lineColor: '#3b82f6',
    fillColor: 'rgba(59, 130, 246, 0.3)'
  }) : null;

  var sparklineDisk = diskCanvas ? new Sparkline(diskCanvas, [], {
    lineWidth: baseOptions.lineWidth,
    pointRadius: baseOptions.pointRadius,
    showArea: baseOptions.showArea,
    padding: baseOptions.padding,
    animate: baseOptions.animate,
    lineColor: '#A47D5B',
    fillColor: 'rgba(164, 125, 91, 0.3)'
  }) : null;

  // Load cluster history
  function loadClusterHistory() {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', '/api/stats/cluster/history?hours=1&bucket=5', true);
    xhr.timeout = 10000;

    xhr.onreadystatechange = function() {
      if (xhr.readyState !== 4) return;

      if (xhr.status === 200) {
        try {
          var response = JSON.parse(xhr.responseText);
          var data = response.data;

          if (data && data.length > 0) {
            var cpuData = [];
            var ramData = [];
            var diskData = [];

            for (var i = 0; i < data.length; i++) {
              if (data[i].cpu_percent !== null) cpuData.push(data[i].cpu_percent);
              if (data[i].ram_percent !== null) ramData.push(data[i].ram_percent);
              if (data[i].disk_percent !== null) diskData.push(data[i].disk_percent);
            }

            if (sparklineCpu && cpuData.length > 0) sparklineCpu.update(cpuData);
            if (sparklineRam && ramData.length > 0) sparklineRam.update(ramData);
            if (sparklineDisk && diskData.length > 0) sparklineDisk.update(diskData);
          }
        } catch (e) {
          console.warn('[ClusterSparklines] Parse error:', e);
        }
      }
    };

    xhr.send();
  }

  // Initial load
  loadClusterHistory();

  // Refresh every 30 seconds
  setInterval(loadClusterHistory, 30000);
})();
</script>
