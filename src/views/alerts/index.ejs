<%- include('../partials/header', { currentPath: '/alerts' }) %>

<div class="app-layout">
  <%- include('../partials/side-panel') %>

  <main class="main-panel">

<div class="page-header">
  <h1>Alerts</h1>
  <div class="page-actions">
    <div class="alert-counts">
      <% if (alertCounts.critical > 0) { %>
        <span class="alert-count-badge critical"><%= alertCounts.critical %> Kritisch</span>
      <% } %>
      <% if (alertCounts.warning > 0) { %>
        <span class="alert-count-badge warning"><%= alertCounts.warning %> Warnung</span>
      <% } %>
      <% if (alertCounts.active === 0) { %>
        <span class="alert-count-badge ok">Keine aktiven Alerts</span>
      <% } %>
    </div>
  </div>
</div>

<!-- Filter Tabs -->
<div class="alerts-tabs" role="tablist">
  <a href="/alerts?filter=active" class="alerts-tab <%= filter === 'active' ? 'active' : '' %>" role="tab">
    Aktiv (<%= alertCounts.active %>)
  </a>
  <a href="/alerts?filter=all" class="alerts-tab <%= filter === 'all' ? 'active' : '' %>" role="tab">
    Alle
  </a>
  <a href="/alerts?filter=archived" class="alerts-tab <%= filter === 'archived' ? 'active' : '' %>" role="tab">
    Archiviert
  </a>
</div>

<% if (alerts.length === 0) { %>
  <% if (filter === 'active') { %>
    <div class="empty-state empty-state-success">
      <div class="empty-state-icon">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <path d="M8 12l2.5 2.5L16 9"/>
        </svg>
      </div>
      <div class="empty-state-title">Alles in Ordnung!</div>
      <p class="empty-state-text">Keine aktiven Alerts. Alle Systeme laufen normal.</p>
    </div>
  <% } else if (filter === 'archived') { %>
    <div class="empty-state">
      <div class="empty-state-icon">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M21 8v13H3V8"/>
          <path d="M1 3h22v5H1z"/>
          <path d="M10 12h4"/>
        </svg>
      </div>
      <div class="empty-state-title">Archiv leer</div>
      <p class="empty-state-text">Keine archivierten Alerts vorhanden.</p>
    </div>
  <% } else { %>
    <div class="empty-state">
      <div class="empty-state-icon">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
          <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
        </svg>
      </div>
      <div class="empty-state-title">Keine Alerts</div>
      <p class="empty-state-text">Es wurden noch keine Alerts aufgezeichnet.</p>
    </div>
  <% } %>
<% } else { %>
  <div class="alerts-list">
    <% alerts.forEach(function(alert) { %>
      <div class="alert-item <%= alert.resolved_at ? 'resolved' : '' %> <%= alert.alert_level %>">
        <div class="alert-icon">
          <% if (alert.resolved_at) { %>
            <svg viewBox="0 0 24 24" width="24" height="24" class="icon-resolved">
              <path fill="currentColor" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
            </svg>
          <% } else if (alert.alert_level === 'critical') { %>
            <svg viewBox="0 0 24 24" width="24" height="24" class="icon-critical">
              <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
            </svg>
          <% } else { %>
            <svg viewBox="0 0 24 24" width="24" height="24" class="icon-warning">
              <path fill="currentColor" d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
            </svg>
          <% } %>
        </div>

        <div class="alert-content">
          <div class="alert-header">
            <span class="alert-level-badge <%= alert.alert_level %>">
              <%= alert.alert_level === 'critical' ? 'KRITISCH' : 'WARNUNG' %>
            </span>
            <a href="/nodes/<%= alert.node_id %>" class="alert-node-name"><%= alert.node_name %></a>
            <span class="alert-type"><%= alert.alert_type.toUpperCase() %></span>
          </div>
          <div class="alert-message"><%= alert.message %></div>
          <div class="alert-meta">
            <span class="alert-time">
              <%
                var createdDate = new Date(alert.created_at * 1000);
                var now = new Date();
                var diffMs = now - createdDate;
                var diffMins = Math.floor(diffMs / 60000);
                var diffHours = Math.floor(diffMs / 3600000);
                var diffDays = Math.floor(diffMs / 86400000);

                var timeAgo = '';
                if (diffMins < 1) {
                  timeAgo = 'gerade eben';
                } else if (diffMins < 60) {
                  timeAgo = 'vor ' + diffMins + ' Min';
                } else if (diffHours < 24) {
                  timeAgo = 'vor ' + diffHours + ' Std';
                } else {
                  timeAgo = 'vor ' + diffDays + ' Tag' + (diffDays > 1 ? 'en' : '');
                }
              %>
              <%= timeAgo %>
            </span>
            <% if (alert.value !== null) { %>
              <span class="alert-value">
                Wert: <%= alert.value.toFixed(1) %><%= alert.alert_type === 'temp' ? ' C' : '%' %>
              </span>
            <% } %>
            <% if (alert.resolved_at) { %>
              <span class="alert-resolved-time">
                <%
                  var resolvedDate = new Date(alert.resolved_at * 1000);
                %>
                Behoben: <%= resolvedDate.toLocaleString('de-DE') %>
              </span>
            <% } %>
          </div>
        </div>

        <div class="alert-actions">
          <% if (!alert.resolved_at && !alert.acknowledged) { %>
            <form action="/alerts/<%= alert.id %>/acknowledge" method="POST" style="display: inline;">
              <button type="submit" class="btn btn-sm btn-secondary" title="Bestaetigen">
                Bestaetigen
              </button>
            </form>
          <% } else if (alert.acknowledged && !alert.resolved_at) { %>
            <span class="alert-acknowledged-badge">Bestaetigt</span>
          <% } %>
        </div>
      </div>
    <% }); %>
  </div>
<% } %>

  </main>
</div>

<script>
// Show toast for acknowledged alert (ES5)
(function() {
  var urlParams = window.location.search;
  if (urlParams.indexOf('acknowledged=1') > -1) {
    if (typeof Toast !== 'undefined') {
      Toast.success('Alert wurde best√§tigt');
    }
    // Clean up URL
    if (window.history && window.history.replaceState) {
      window.history.replaceState({}, document.title, window.location.pathname);
    }
  }
})();
</script>

<%- include('../partials/footer') %>
